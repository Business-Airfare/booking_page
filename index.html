<!-- =========================
     BA PAYMENT PAGE — FULL
     Paste this whole thing in ONE place
========================= -->

<div id="baPayRoot"></div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3"></script>

<script>
(function () {
  const STRIPE_PUBLISHABLE_KEY = "pk_test_51RpG5EIb9TlAdJMajS3FihUE4iCrGg1egeXP6zXIZikRLV9hSuNpeXcYqnna968mOYw0RTcrboKPYYBjfXQA3aE600eLwmPhad";
  const SUPABASE_FUNCTIONS_BASE = "https://ofyciacvdpwpkcbbmmxj.supabase.co/functions/v1";
  const GET_SESSION = SUPABASE_FUNCTIONS_BASE + "/get_public_session";
  const UPDATE_SELECTION = SUPABASE_FUNCTIONS_BASE + "/update_selection";
  const START_PAYMENT = SUPABASE_FUNCTIONS_BASE + "/start_payment";
  const UPDATE_PAX = SUPABASE_FUNCTIONS_BASE + "/update_passenger_details";
  const RECORD_ACCEPTANCE = SUPABASE_FUNCTIONS_BASE + "/record_acceptance";

  function qs(name){
    return new URLSearchParams(window.location.search).get(name);
  }
  const publicId = qs("public_id");

  const root = document.getElementById("baPayRoot");
  if (!root) return;

  // ---------- helpers ----------
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ));
  }

  function renderLoading(){
    root.innerHTML = `
      <div style="position:fixed;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;font-family:system-ui;background:#fff;z-index:99999">
        <div style="width:32px;height:32px;border:3px solid #f0f0f0;border-top-color:#d1ad54;border-radius:50%;animation:spin 0.8s linear infinite"></div>
        <div style="font-weight:700;font-size:15px;color:#333">Loading booking page</div>
      </div>
      <style>
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
      </style>
    `;
  }

  function renderError(msg){
    root.innerHTML =
      '<div style="padding:24px;font-family:system-ui;color:#b00020">Error: ' +
      escapeHtml(msg) + '</div>';
  }

  function fmtMoney(cents){
    if (typeof cents !== "number") return "—";
    const dollars = cents/100;
    const formatted = dollars.toFixed(2);
    const parts = formatted.split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return "$" + parts.join(".");
  }

  function fmtPhoneDisplay(phoneStr){
    if (!phoneStr) return "";
    const digits = String(phoneStr).replace(/\D/g, "");
    if (digits.length === 10) {
      return digits.slice(0, 3) + "-" + digits.slice(3, 6) + "-" + digits.slice(6);
    }
    if (digits.length === 11 && digits.startsWith("1")) {
      return digits.slice(1, 4) + "-" + digits.slice(4, 7) + "-" + digits.slice(7);
    }
    if (phoneStr.startsWith("+1")) {
      const rest = phoneStr.slice(2).replace(/\D/g, "");
      if (rest.length === 10) {
        return rest.slice(0, 3) + "-" + rest.slice(3, 6) + "-" + rest.slice(6);
      }
    }
    return phoneStr;
  }

  function dtToParts(localStr){ // "YYYY-MM-DD HH:MM"
    if (!localStr || localStr.length < 16) return null;
    return {
      y: +localStr.slice(0,4),
      m: +localStr.slice(5,7),
      d: +localStr.slice(8,10),
      hh: +localStr.slice(11,13),
      mm: +localStr.slice(14,16),
      date: localStr.slice(0,10)
    };
  }

  function fmt12(localStr){
    const p = dtToParts(localStr);
    if (!p) return "—";
    const ampm = p.hh >= 12 ? "PM" : "AM";
    let h = p.hh % 12;
    if (h === 0) h = 12;
    return `${h}:${String(p.mm).padStart(2,"0")} ${ampm}`;
  }

  function monthDayLabel(localStr){ // -> "Jun 04"
    const p = dtToParts(localStr);
    if (!p) return "—";
    const d = new Date(Date.UTC(p.y, p.m - 1, p.d));
    return d.toLocaleDateString(undefined, { month:"short", day:"2-digit" });
  }

  function dateHeaderLabel(yyyy_mm_dd){
    const d = new Date(yyyy_mm_dd + "T00:00:00Z");
    return d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" });
  }

  function minsToHM(mins){
    if (mins == null || !Number.isFinite(mins)) return "—";
    const m = Math.max(0, Math.round(mins));
    const h = Math.floor(m/60);
    const mm = m % 60;
    return `${h}h ${String(mm).padStart(2,"0")}m`;
  }

  function minsToHMM(mins){ // -> "3:35"
    if (mins == null || !Number.isFinite(mins)) return "";
    const m = Math.max(0, Math.round(mins));
    const h = Math.floor(m/60);
    const mm = m % 60;
    return `${h}:${String(mm).padStart(2,"0")}`;
  }

  function numberToWords(cents){
    const ones = ["", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine"];
    const teens = ["ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", "seventeen", "eighteen", "nineteen"];
    const tens = ["", "", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];

    if (cents === 0) return "zero";

    function convertHundreds(n){
      let result = "";
      if (n >= 100) {
        result += ones[Math.floor(n / 100)] + " hundred";
        n %= 100;
        if (n > 0) result += " ";
      }
      if (n >= 20) {
        result += tens[Math.floor(n / 10)];
        n %= 10;
        if (n > 0) result += "-" + ones[n];
      } else if (n >= 10) {
        result += teens[n - 10];
      } else if (n > 0) {
        result += ones[n];
      }
      return result;
    }

    const dollars = Math.floor(cents / 100);
    const centsRem = cents % 100;

    let words = "";
    if (dollars >= 1000) {
      const thousands = Math.floor(dollars / 1000);
      words += convertHundreds(thousands) + " thousand";
      const hundreds = dollars % 1000;
      if (hundreds > 0) {
        words += " " + convertHundreds(hundreds);
      }
    } else {
      words = convertHundreds(dollars);
    }

    words += " US dollar" + (dollars !== 1 ? "s" : "");
    if (centsRem > 0) {
      words += " and " + convertHundreds(centsRem) + " cent" + (centsRem !== 1 ? "s" : "");
    } else {
      words += " and zero cents";
    }

    return words;
  }

  function expiresClock(expiresAtISO){
    const exp = new Date(expiresAtISO).getTime();
    const now = Date.now();
    const s = Math.max(0, Math.floor((exp - now)/1000));
    if (s <= 0) return "00:00:00";
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
  }

  const AIRLINE_NAMES = {
    UA: "United Airlines",
    LH: "Lufthansa",
    LX: "Swiss International Air Lines",
    AA: "American Airlines",
    DL: "Delta Air Lines",
    AF: "Air France",
    KL: "KLM",
    BA: "British Airways",
    EY: "Etihad Airways",
  };

  // Format cabin name from backend format to display format
  function formatCabinName(cabin) {
    if (!cabin) return "";
    const c = String(cabin).toLowerCase().trim();
    if (c === "first") return "First";
    if (c === "business") return "Business";
    if (c === "premium_economy" || c === "premium-economy" || c === "premium economy") return "Premium Economy";
    if (c === "economy") return "Economy";
    return cabin; // fallback to original if not recognized
  }

  function cabinFromClass(cls, carrier){
    const c = String(cls || "").toUpperCase();
    const a = String(carrier || "").toUpperCase();
    if (!c) return "";
    if ((a === "AF" || a === "DL") && c === "A") return "Premium Economy";
    if (c === "F" || c === "A") return "First";
    if ("JCDIZP".includes(c)) return "Business";
    if (c === "W") return "Premium Economy";
    return "Economy";
  }

  function logoUrl(carrier){
    return `https://pnrexpert.b-cdn.net/images/airlines/${String(carrier||"").toLowerCase()}.png`;
  }

  function cityPairFromJourney(j){
    const segs = Array.isArray(j?.segments) ? j.segments : [];
    if (!segs.length) return { fromCity:"—", toCity:"—", fromIata:"", toIata:"" };
    const first = segs[0];
    const last = segs[segs.length - 1];
    return {
      fromCity: first?.origin_city || "",
      toCity: last?.destination_city || "",
      fromIata: first?.origin || "",
      toIata: last?.destination || ""
    };
  }

  function clampInt(n, min, max){
    const x = Math.round(Number(n));
    if (!Number.isFinite(x)) return min;
    return Math.min(max, Math.max(min, x));
  }

  function segmentFlightTime(s){
    const mins =
      (Number.isFinite(s?.flight_minutes) ? s.flight_minutes : null) ??
      (Number.isFinite(s?.duration_minutes) ? s.duration_minutes : null) ??
      (Number.isFinite(s?.elapsed_minutes) ? s.elapsed_minutes : null);

    if (mins != null) {
      const hmm = minsToHMM(mins);
      return hmm ? `Flight time: ${hmm}` : "";
    }

    const st = String(s?.flight_time || s?.duration || "").trim();
    if (st) return `Flight time: ${st}`;
    return "";
  }

  function segmentMealText(s){
    return String(s?.meal || s?.meal_text || s?.service_meal || "").trim();
  }

  // ---------- Stripe state ----------
  let stripe = null;
  let elements = null;
  let paymentElement = null;
  let linkAuthElement = null;
  let addressElement = null;
  let currentClientSecret = null; // Track current PaymentIntent client_secret

  let billingEmail = "";
  let billingAddressComplete = false;
  
  // ---------- Acceptance state (global scope so validateBillingUI can access it) ----------
  let acceptanceCompleted = false;
  let acceptanceInProgress = false;
  let tipSaveError = null; // Track if tip save failed (global scope for validateBillingUI)

  function normalizePhone(s){
    return String(s || "").trim();
  }

  function setConfirmEnabled(enabled){
    const confirmBtn = document.getElementById("baStripeConfirm");
    const msg = document.getElementById("baStripeMsg");
    if (!confirmBtn) return;
    confirmBtn.disabled = !enabled;
    confirmBtn.style.opacity = enabled ? "1" : ".6";
    confirmBtn.style.cursor = enabled ? "pointer" : "not-allowed";
    // Use pointer-events to truly prevent clicks when disabled
    confirmBtn.style.pointerEvents = enabled ? "auto" : "none";
    if (!enabled && msg && !msg.textContent) {
      msg.textContent = "Please enter billing details to continue.";
    }
  }

  function validateBillingUI(){
    const emailOk = !!(billingEmail && billingEmail.includes("@"));
    const addrOk = !!billingAddressComplete;
    
    // Check terms and conditions checkbox - ALWAYS required
    const termsCheckbox = document.getElementById("baTermsAgreeCheck");
    const termsOk = termsCheckbox ? termsCheckbox.checked : false;
    
    // Check tips agreement checkbox - required if a tip is selected
    // Check if any tip button is active (has tip selected)
    const tipAgreeCheckbox = document.getElementById("baTipAgree");
    const tipBtns = document.querySelectorAll(".baTipBtn.is-active[data-mode='preset'], .baTipBtn.is-active[data-mode='custom']");
    const hasTipSelected = tipBtns.length > 0;
    const tipsOk = !hasTipSelected || (tipAgreeCheckbox ? tipAgreeCheckbox.checked : false);
    
    // Check if tip save failed - block payment if there's a tip save error
    // Only block if tip is selected (hasTipSelected), not if tip is zero
    const tipSaveOk = !hasTipSelected || !tipSaveError;
    
    // Acceptance must be completed before payment can proceed
    // Note: acceptanceCompleted is set by updateTermsAgreementUI/updateTipAgreementUI
    const acceptanceOk = acceptanceCompleted;
    
    const result = emailOk && addrOk && termsOk && tipsOk && tipSaveOk && acceptanceOk;
    
    // Debug logging - always log to help diagnose issues
    console.log("[BOOK_FLOW] validateBillingUI result:", {
      result,
      emailOk,
      addrOk,
      termsOk,
      tipsOk,
      acceptanceOk,
      acceptanceCompleted,
      billingEmail: billingEmail ? (billingEmail.substring(0, 3) + "***") : null,
      billingAddressComplete,
      timestamp: new Date().toISOString()
    });
    
    return result;
  }

  async function mountStripePaymentElement(clientSecret, preserveState = false){
    if (!window.Stripe) throw new Error("Stripe.js failed to load");
    if (!stripe) stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

    // If we already have elements and the client_secret hasn't changed, don't remount
    if (preserveState && elements && currentClientSecret === clientSecret) {
      return; // No need to remount - same PaymentIntent
    }

    // If elements exist and we're updating, preserve scroll position and add loading overlay
    const wasMounted = !!elements;
    const stripeWrap = document.getElementById("baStripeWrap");
    const scrollPos = wasMounted ? window.scrollY : null;
    let loadingOverlay = null;

    if (wasMounted && preserveState) {
      // Add subtle loading overlay instead of clearing everything
      loadingOverlay = document.createElement("div");
      loadingOverlay.id = "baStripeLoadingOverlay";
      loadingOverlay.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 12px;
      `;
      loadingOverlay.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
          <div style="width:24px;height:24px;border:3px solid #f0f0f0;border-top-color:#d1ad54;border-radius:50%;animation:spin 0.8s linear infinite"></div>
          <div style="font-size:13px;color:#666;font-weight:700">Updating payment amount...</div>
        </div>
      `;
      if (stripeWrap) {
        const existingOverlay = stripeWrap.querySelector("#baStripeLoadingOverlay");
        if (existingOverlay) existingOverlay.remove();
        stripeWrap.style.position = "relative";
        stripeWrap.appendChild(loadingOverlay);
      }
    }

    // Unmount old elements if they exist (Stripe requires this before mounting new ones)
    if (wasMounted) {
      try {
        if (linkAuthElement) {
          try { linkAuthElement.unmount(); } catch(e) {}
        }
        if (addressElement) {
          try { addressElement.unmount(); } catch(e) {}
        }
        if (paymentElement) {
          try { paymentElement.unmount(); } catch(e) {}
        }
      } catch (e) {
        // Ignore unmount errors - elements might already be unmounted
      }
    }

    // Clear mount containers
    const linkMount = document.getElementById("baLinkAuthMount");
    const addrMount = document.getElementById("baAddressMount");
    const payMount = document.getElementById("baStripeMount");
    
    if (linkMount) linkMount.innerHTML = "";
    if (addrMount) addrMount.innerHTML = "";
    if (payMount) payMount.innerHTML = "";

    // Create new elements
    elements = stripe.elements({
      clientSecret,
      appearance: { theme: "stripe" },
      loader: "auto"
    });

    linkAuthElement = elements.create("linkAuthentication");
    if (!linkMount) throw new Error("Missing baLinkAuthMount container");
    linkAuthElement.mount("#baLinkAuthMount");

    linkAuthElement.on("change", (event) => {
      billingEmail = (event && event.value && event.value.email) ? String(event.value.email) : "";
      const ok = validateBillingUI();
      const m = document.getElementById("baStripeMsg");
      if (m) m.textContent = ok ? "" : "Please enter billing details to continue.";
      setConfirmEnabled(ok);
    });

    addressElement = elements.create("address", {
      mode: "billing",
      fields: { phone: "always" },
      defaultValues: { address: { country: "US" } }
    });

    if (!addrMount) throw new Error("Missing baAddressMount container");
    addressElement.mount("#baAddressMount");

    addressElement.on("change", (event) => {
      billingAddressComplete = !!(event && event.complete);
      const ok = validateBillingUI();
      const m = document.getElementById("baStripeMsg");
      if (m) m.textContent = ok ? "" : "Please enter billing details to continue.";
      setConfirmEnabled(ok);
    });

    paymentElement = elements.create("payment", { layout: "tabs" });
    if (!payMount) throw new Error("Missing baStripeMount container");
    paymentElement.mount("#baStripeMount");

    // Store current client_secret
    currentClientSecret = clientSecret;

    // Remove loading overlay after a short delay to allow elements to render
    if (loadingOverlay) {
      setTimeout(() => {
        if (loadingOverlay && loadingOverlay.parentNode) {
          loadingOverlay.style.opacity = "0";
          loadingOverlay.style.transition = "opacity 0.2s ease";
          setTimeout(() => {
            if (loadingOverlay && loadingOverlay.parentNode) {
              loadingOverlay.remove();
            }
          }, 200);
        }
      }, 400);
    }
  }

  // Wait for Stripe Elements to be fully mounted and visible
  // Returns a promise that resolves when Stripe is ready, or rejects after timeout
  function waitForStripeReady(timeoutMs = 8000) {
    return new Promise((resolve, reject) => {
      const startTime = Date.now();
      
      // Check if already ready
      if (paymentElement && elements) {
        const payMount = document.getElementById("baStripeMount");
        if (payMount) {
          // Check if container has iframes (Stripe Elements render as iframes)
          const hasIframes = payMount.querySelector("iframe") !== null;
          if (hasIframes) {
            resolve();
            return;
          }
        }
      }

      const checkInterval = 50; // Poll every 50ms
      let readyCheckCount = 0; // Track consecutive ready checks
      const requiredReadyChecks = 10; // Require 10 consecutive checks (500ms) to ensure stability
      let firstStableDetectionTime = null; // Track when we first detected stable iframes
      const MIN_TIME_AFTER_STABLE = 3500; // Wait at least 3.5 seconds after iframes are stable
      
      const checkId = setInterval(() => {
        const elapsed = Date.now() - startTime;
        
        if (elapsed > timeoutMs) {
          clearInterval(checkId);
          reject(new Error("Stripe Elements failed to load within timeout"));
          return;
        }

        // Check if paymentElement exists and mount container has content
        if (paymentElement && elements) {
          const payMount = document.getElementById("baStripeMount");
          const linkMount = document.getElementById("baLinkAuthMount");
          const addrMount = document.getElementById("baAddressMount");
          
          if (payMount && linkMount && addrMount) {
            // Check for iframes (Stripe Elements render as iframes)
            const paymentIframe = payMount.querySelector("iframe");
            const linkIframe = linkMount.querySelector("iframe");
            const addrIframe = addrMount.querySelector("iframe");
            
            const hasPaymentIframe = paymentIframe !== null;
            const hasLinkIframe = linkIframe !== null;
            const hasAddrIframe = addrIframe !== null;
            
            // All three elements should have iframes when ready
            if (hasPaymentIframe && hasLinkIframe && hasAddrIframe) {
              // Verify iframes are actually loaded (not just present)
              // Check if iframes have dimensions (loaded iframes have width/height)
              const paymentLoaded = paymentIframe.offsetWidth > 0 && paymentIframe.offsetHeight > 0;
              const linkLoaded = linkIframe.offsetWidth > 0 && linkIframe.offsetHeight > 0;
              const addrLoaded = addrIframe.offsetWidth > 0 && addrIframe.offsetHeight > 0;
              
              // All iframes must be loaded for consecutive checks to count
              if (paymentLoaded && linkLoaded && addrLoaded) {
                // Track when we first detected stable iframes
                if (firstStableDetectionTime === null) {
                  firstStableDetectionTime = Date.now();
                }
                
                readyCheckCount++;
                // Require multiple consecutive ready checks to ensure stability (500ms)
                if (readyCheckCount >= requiredReadyChecks) {
                  // Calculate how long we've waited since first stable detection
                  const timeSinceStable = Date.now() - firstStableDetectionTime;
                  const remainingWait = Math.max(0, MIN_TIME_AFTER_STABLE - timeSinceStable);
                  
                  if (remainingWait === 0) {
                    // We've waited long enough - resolve immediately
                    clearInterval(checkId);
                    resolve();
                    return;
                  } else {
                    // Wait a bit longer
                    clearInterval(checkId);
                    setTimeout(() => resolve(), remainingWait);
                    return;
                  }
                }
              } else {
                // Reset counter if any iframe is not ready
                readyCheckCount = 0;
                firstStableDetectionTime = null;
              }
            } else {
              // Reset counter if iframes not present
              readyCheckCount = 0;
              firstStableDetectionTime = null;
            }
          }
        }
      }, checkInterval);
    });

    // Restore scroll position if we had one
    if (scrollPos !== null) {
      requestAnimationFrame(() => {
        window.scrollTo(0, scrollPos);
      });
    }

    setConfirmEnabled(validateBillingUI());
  }

  async function confirmStripePayment(){
    console.log("[BOOK_FLOW] Pay button clicked - will record acceptance, call start_payment, then confirm with Stripe");
    
    // HARD VALIDATION: Check all required checkboxes before proceeding
    const termsCheckbox = document.getElementById("baTermsAgreeCheck");
    if (!termsCheckbox || !termsCheckbox.checked) {
      throw new Error("Please accept the Terms and Conditions to proceed with payment.");
    }
    
    // Check tips agreement if tip is selected
    const tipAgreeCheckbox = document.getElementById("baTipAgree");
    const tipBtns = document.querySelectorAll(".baTipBtn.is-active[data-mode='preset'], .baTipBtn.is-active[data-mode='custom']");
    const hasTipSelected = tipBtns.length > 0;
    if (hasTipSelected && (!tipAgreeCheckbox || !tipAgreeCheckbox.checked)) {
      throw new Error("Please accept the tip agreement to proceed with payment.");
    }

    // Ensure Stripe Elements are initialized
    if (!stripe || !elements || !paymentElement) {
      console.log("[BOOK_FLOW] Stripe Elements not initialized, calling initializePayment");
      await initializePayment();
    } else {
      console.log("[BOOK_FLOW] Stripe Elements already initialized, checking acceptance state");
      // If Stripe is already initialized but acceptance not recorded, record it now
      if (!acceptanceCompleted) {
        console.log("[BOOK_FLOW] Acceptance not completed, recording now");
        try {
          const acceptRes = await fetch(RECORD_ACCEPTANCE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              public_id: publicId, 
              tip_ack: true, 
              terms_accepted: true 
            })
          });
          const acceptPayload = await acceptRes.json().catch(() => ({}));
          console.log("[BOOK_FLOW] record_acceptance response", {
            status: acceptRes.status,
            ok: acceptRes.ok,
            payload: acceptPayload
          });
          if (!acceptRes.ok) {
            throw new Error(`Failed to record acceptance: ${acceptPayload?.error || acceptRes.status}`);
          }
          acceptanceCompleted = true;
          
          // Update PaymentIntent metadata with acceptance info
          // This ensures the PaymentIntent has correct acceptance metadata before confirmation
          console.log("[BOOK_FLOW] Updating PaymentIntent metadata with acceptance info");
          try {
            const updateRes = await fetch(START_PAYMENT, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ public_id: publicId })
            });
            const updatePayload = await updateRes.json().catch(() => ({}));
            if (updateRes.ok && updatePayload.client_secret) {
              // PaymentIntent was updated, but we don't need to remount Stripe Elements
              // The client_secret should be the same, so existing elements will work
              console.log("[BOOK_FLOW] PaymentIntent metadata updated successfully");
            } else {
              console.warn("[BOOK_FLOW] Could not update PaymentIntent metadata, but continuing with payment");
            }
          } catch (updateErr) {
            console.warn("[BOOK_FLOW] Error updating PaymentIntent metadata:", updateErr);
            // Don't throw - we can still proceed with payment
          }
        } catch (acceptErr) {
          console.error("[BOOK_FLOW] record_acceptance error", acceptErr);
          throw new Error(`Acceptance required: ${acceptErr.message}`);
        }
      }
    }

    if (!linkAuthElement) throw new Error("Email element not initialized.");
    if (!billingEmail) throw new Error("Please enter a valid billing email.");

    if (!addressElement) throw new Error("Address element not initialized.");
    const addr = await addressElement.getValue();
    if (!addr || !addr.complete) throw new Error("Please complete the billing address.");

    const address = (addr.value && addr.value.address) ? addr.value.address : null;
    const phone = normalizePhone(addr.value && addr.value.phone ? addr.value.phone : "");
    const billingName = String((addr.value && addr.value.name) ? addr.value.name : "").trim();
    if (billingName.length < 2) throw new Error("Please enter your full name in the billing address section.");

    console.log("[BOOK_FLOW] Confirming payment with Stripe", {
      hasElements: !!elements,
      hasPaymentElement: !!paymentElement,
      currentClientSecret: currentClientSecret
    });
    
    // Ensure we have valid Stripe Elements before confirming
    if (!elements || !paymentElement) {
      throw new Error("Stripe Elements not properly initialized. Please refresh the page.");
    }
    
    const { error, paymentIntent } = await stripe.confirmPayment({
      elements,
      confirmParams: {
        return_url: window.location.href,
        payment_method_data: {
          billing_details: {
            name: billingName,
            email: billingEmail,
            phone: phone || undefined,
            address: address || undefined,
          }
        }
      },
      redirect: "if_required"
    });

    if (error) {
      console.error("[BOOK_FLOW] Stripe confirmPayment error:", error);
      throw new Error(error.message || "Payment failed");
    }
    
    console.log("[BOOK_FLOW] Payment confirmed successfully", {
      status: paymentIntent?.status,
      id: paymentIntent?.id
    });
    
    return paymentIntent;
  }

  // ---------- selection update ----------
  async function updateSelection(public_id, patch){
    const res = await fetch(UPDATE_SELECTION, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ public_id, ...patch })
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      const errorMsg = data?.error || ("HTTP " + res.status);
      const details = data?.details ? `: ${data.details}` : "";
      throw new Error(errorMsg + details);
    }
    return data;
  }

  // ---------- record acceptance ----------
  async function recordAcceptance(public_id, tip_ack, terms_accepted){
    const res = await fetch(RECORD_ACCEPTANCE, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ public_id, tip_ack, terms_accepted })
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      const errorMsg = data?.error || ("HTTP " + res.status);
      const details = data?.details ? `: ${data.details}` : "";
      throw new Error(errorMsg + details);
    }
    return data;
  }

  // ---------- Paid UI ----------
  function renderPaid(data){
    const pax = (data.passengers || []).join(", ");
    root.innerHTML = `
      <div style="padding:24px;font-family:system-ui;max-width:920px;margin:0 auto">
        <div style="padding:14px 16px;border-radius:12px;background:#f0fff4;border:1px solid #b7f0c2;color:#14532d;margin-bottom:14px">
          <div style="font-weight:900;font-size:16px;margin-bottom:4px">Payment received ✅</div>
          <div style="opacity:.9">Thank you. Your agent will follow up with the next steps.</div>
        </div>

        <div style="display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap">
          <div>
            <div style="font-size:14px;opacity:.75">Passengers</div>
            <div style="font-weight:700">${escapeHtml(pax || "—")}</div>
          </div>
          <div>
            <div style="font-size:14px;opacity:.75">Paid</div>
            <div style="font-weight:900;font-size:18px">
              ${fmtMoney(data.paid_amount ?? data.final_amount ?? data.total_amount)} ${escapeHtml(data.currency || "USD")}
            </div>
          </div>
          <div>
            <div style="font-size:14px;opacity:.75">Paid at</div>
            <div style="font-weight:800">${escapeHtml(data.paid_at ? new Date(data.paid_at).toLocaleString() : "—")}</div>
          </div>
        </div>

        <div style="margin-top:18px">
          <h2 style="margin:0 0 12px;font-size:34px;letter-spacing:-0.02em">Flight Itinerary</h2>
          <div style="opacity:.85">You can keep this page for your records.</div>
        </div>
      </div>
    `;
  }

  // ----------------------------
  // PASSENGERS (data helpers)
  // ----------------------------
  function getPassengerDetailsArray(d){
    const candidates = [
      d.passenger_details,
      d.passengers_details,
      d.passengerDetails,
      d.passengersDetails,
      d.pax_details,
      d.paxDetails,
      d.travelers,
      d.travellers
    ];
    for (const c of candidates){
      if (Array.isArray(c) && c.length) return c;
    }
    return null;
  }

  function splitFullName(full){
    const s = String(full || "").trim().replace(/\s+/g, " ");
    if (!s) return { first:"", last:"" };
    const parts = s.split(" ");
    if (parts.length === 1) return { first: parts[0], last: "" };
    return { first: parts[0], last: parts.slice(1).join(" ") };
  }

  function normalizeGender(g){
    const s = String(g || "").trim().toLowerCase();
    if (s === "m" || s === "male") return "male";
    if (s === "f" || s === "female") return "female";
    return "";
  }

  function isoDob(dob){
    const s = String(dob || "").trim();
    if (!s) return "";
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m = s.match(/^(\d{2})-([A-Za-z]{3})-(\d{4})$/);
    if (m){
      const dd = m[1];
      const mon = m[2].toLowerCase();
      const yyyy = m[3];
      const map = {jan:"01",feb:"02",mar:"03",apr:"04",may:"05",jun:"06",jul:"07",aug:"08",sep:"09",oct:"10",nov:"11",dec:"12"};
      const mm = map[mon] || "";
      if (mm) return `${yyyy}-${mm}-${dd}`;
    }
    return s;
  }

  function formatDobDisplay(isoStr){
    if (!isoStr || !/^\d{4}-\d{2}-\d{2}$/.test(isoStr)) return "";
    const parts = isoStr.split("-");
    const yyyy = parts[0];
    const mm = parts[1];
    const dd = parts[2];
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const monthIdx = parseInt(mm, 10) - 1;
    if (monthIdx < 0 || monthIdx > 11) return isoStr;
    return `${dd}-${monthNames[monthIdx]}-${yyyy}`;
  }

  function parseDobInput(textStr){
    const s = String(textStr || "").trim();
    if (!s) return "";
    const m = s.match(/^(\d{2})-([A-Za-z]{3})-(\d{4})$/i);
    if (m){
      const dd = m[1];
      const mon = m[2].toLowerCase();
      const yyyy = m[3];
      const map = {jan:"01",feb:"02",mar:"03",apr:"04",may:"05",jun:"06",jul:"07",aug:"08",sep:"09",oct:"10",nov:"11",dec:"12"};
      const mm = map[mon] || "";
      if (mm) return `${yyyy}-${mm}-${dd}`;
    }
    return s;
  }

  function getPassengerFromSession(data, idx){
    const pdArr = getPassengerDetailsArray(data);
    const p = pdArr && pdArr[idx] ? pdArr[idx] : null;

    const fullArr = Array.isArray(data.passengers) ? data.passengers : [];
    const full = fullArr[idx] ? String(fullArr[idx]) : "";

    // Title case helper
    function toTitleCase(str) {
      if (!str) return "";
      return str.split(/\s+/).map(word => {
        if (!word) return word;
        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
      }).join(" ");
    }
    
    const first  = toTitleCase(String(p?.first_name ?? p?.first ?? "").trim());
    const last   = toTitleCase(String(p?.last_name ?? p?.last ?? "").trim());
    const middle = toTitleCase(String(p?.middle_name ?? p?.middle ?? "").trim());
    const dobISO = isoDob(p?.date_of_birth ?? p?.dob ?? "");
    const email  = String(p?.email ?? "").trim();
    const phone  = String(p?.phone ?? "").trim();
    const gender = normalizeGender(p?.gender);

    if (!p || (!first && !last && !dobISO && !email && !phone && !gender && !middle)){
      const sp = splitFullName(full);
      return {
        first_name: sp.first,
        last_name: sp.last,
        middle_name: "",
        date_of_birth: "",
        email: "",
        phone: "",
        gender: "",
        dobISO: "",
        full
      };
    }

    let first2 = first, last2 = last;
    if (!first2 && !last2 && full){
      const sp = splitFullName(full);
      first2 = sp.first; last2 = sp.last;
    }

    return {
      first_name: first2,
      last_name: last2,
      middle_name: middle,
      date_of_birth: dobISO,
      email,
      phone,
      gender,
      dobISO,
      full
    };
  }

  // ---------- passenger validation UI ----------
  function isValidEmail(v){
    const s = String(v || "").trim();
    if (!s) return false; // required
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
  }
  function isValidPhone(v){
    const s = String(v || "").trim();
    if (!s) return false; // required
    // Normalize: remove all non-digits except leading +
    const normalized = s.replace(/[^\d+]/g, "");
    // Must start with +1 and have exactly 11 digits total (+1 + 10 digits)
    if (!normalized.startsWith("+1")) return false;
    const digitsOnly = normalized.replace(/\+/g, "");
    return digitsOnly.length === 11 && digitsOnly.startsWith("1");
  }
  
  function normalizePhone(v){
    if (!v) return "+1";
    // Remove all non-digits
    const digits = String(v).replace(/\D/g, "");
    // If starts with 1, assume it's already country code
    if (digits.startsWith("1") && digits.length === 11) {
      return "+" + digits;
    }
    // Otherwise, assume it's 10 digits US number
    if (digits.length === 10) {
      return "+1" + digits;
    }
    // If already has +1 prefix
    if (v.startsWith("+1")) {
      const rest = v.slice(2).replace(/\D/g, "");
      if (rest.length === 10) return "+1" + rest;
    }
    return "+1" + digits.slice(-10);
  }
  function isValidDobISO(v){
    const s = String(v || "").trim();
    if (!s) return false; // required
    // Accept both DD-MMM-YYYY and YYYY-MM-DD formats
    let isoDate = s;
    if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) {
      // Try to parse DD-MMM-YYYY format
      isoDate = parseDobInput(s);
      if (!isoDate || !/^\d{4}-\d{2}-\d{2}$/.test(isoDate)) return false;
    }
    const d = new Date(isoDate + "T00:00:00Z");
    if (Number.isNaN(d.getTime())) return false;
    // sanity: not in future, not older than 120 years
    const now = new Date();
    if (d.getTime() > now.getTime()) return false;
    const oldest = new Date();
    oldest.setUTCFullYear(oldest.getUTCFullYear() - 120);
    if (d.getTime() < oldest.getTime()) return false;
    return true;
  }

  function setFieldInvalid(inputEl, invalid){
    if (!inputEl) return;
    inputEl.classList.toggle("is-invalid", !!invalid);
    // For phone field, also mark the wrapper div
    if (inputEl.getAttribute("data-field") === "phone") {
      const wrapper = inputEl.closest(".baPhoneWrapper");
      if (wrapper) wrapper.classList.toggle("is-invalid", !!invalid);
    }
  }

  function validatePassengerBlock(paxIndex){
    const box = root.querySelector(`.baPaxCard[data-pax-card="${paxIndex}"]`);
    if (!box) return true;

    const first = box.querySelector(`.baBoxInput[data-pax="${paxIndex}"][data-field="first_name"]`);
    const last  = box.querySelector(`.baBoxInput[data-pax="${paxIndex}"][data-field="last_name"]`);
    const dob   = box.querySelector(`.baBoxInput[data-pax="${paxIndex}"][data-field="date_of_birth"]`);
    const email = box.querySelector(`.baBoxInput[data-pax="${paxIndex}"][data-field="email"]`);
    const phone = box.querySelector(`.baBoxInput[data-pax="${paxIndex}"][data-field="phone"]`);

    const male = box.querySelector(`input[type="radio"][data-pax="${paxIndex}"][data-field="gender"][value="male"]`);
    const female = box.querySelector(`input[type="radio"][data-pax="${paxIndex}"][data-field="gender"][value="female"]`);
    const genderOk = !!((male && male.checked) || (female && female.checked));

    const firstOk = String(first?.value || "").trim().length > 0;
    const lastOk  = String(last?.value  || "").trim().length > 0;
    // Convert DD-MMM-YYYY to ISO for validation if needed
    const dobValue = dob?.value || "";
    const dobIso = /^\d{4}-\d{2}-\d{2}$/.test(dobValue) ? dobValue : parseDobInput(dobValue);
    const dobOk   = isValidDobISO(dobIso);
    const emailOk = isValidEmail(email?.value || "");
    // For phone, the input field only contains digits (10 digits), we validate with +1 prefix
    const phoneDigits = phone?.value ? String(phone.value).replace(/\D/g, "") : "";
    const phoneOk = isValidPhone(phoneDigits.length === 10 ? "+1" + phoneDigits : phoneDigits);

    setFieldInvalid(first, !firstOk);
    setFieldInvalid(last,  !lastOk);
    setFieldInvalid(dob,   !dobOk);
    setFieldInvalid(email, !emailOk);
    setFieldInvalid(phone, !phoneOk);

    // gender highlight: add class on the container row
    const genderWrap = box.querySelector(".baPaxGender");
    if (genderWrap) genderWrap.classList.toggle("is-invalid", !genderOk);

    return firstOk && lastOk && dobOk && emailOk && phoneOk && genderOk;
  }

  function validateAllPassengers(paxCount){
    let ok = true;
    for (let i=0;i<paxCount;i++){
      ok = validatePassengerBlock(i) && ok;
    }
    return ok;
  }

  let expandedPassengerIndex = 0;

  function setExpandedPassenger(index){
    const cards = Array.from(root.querySelectorAll(".baPaxCard[data-pax-card]"));
    if (!cards.length) return;
    const safeIndex = Math.max(0, Math.min(index, cards.length - 1));
    expandedPassengerIndex = safeIndex;
    cards.forEach(card => {
      const idx = Number(card.getAttribute("data-pax-card"));
      const isExpanded = idx === expandedPassengerIndex;
      card.classList.toggle("is-expanded", isExpanded);
      card.classList.toggle("is-collapsed", !isExpanded);
    });
  }

  function updatePaxSummary(paxIndex){
    const card = root.querySelector(`.baPaxCard[data-pax-card="${paxIndex}"]`);
    if (!card) return;
    const first = card.querySelector(`.baBoxInput[data-pax="${paxIndex}"][data-field="first_name"]`);
    const last  = card.querySelector(`.baBoxInput[data-pax="${paxIndex}"][data-field="last_name"]`);
    const dob   = card.querySelector(`.baBoxInput[data-pax="${paxIndex}"][data-field="date_of_birth"]`);
    const firstEl = card.querySelector("[data-pax-summary-first]");
    const lastEl = card.querySelector("[data-pax-summary-last]");
    const dobEl = card.querySelector("[data-pax-summary-dob]");
    const genderEl = card.querySelector("[data-pax-summary-gender]");

    const firstVal = String(first?.value || "").trim();
    const lastVal = String(last?.value || "").trim();
    const displayFirst = firstVal || "Passenger";
    const displayLast = lastVal || String(paxIndex + 1);
    if (firstEl) firstEl.textContent = displayFirst;
    if (lastEl) lastEl.textContent = displayLast;

    let dobDisplay = "";
    const dobVal = String(dob?.value || "").trim();
    if (dobVal){
      const iso = /^\d{4}-\d{2}-\d{2}$/.test(dobVal) ? dobVal : parseDobInput(dobVal);
      dobDisplay = (iso && /^\d{4}-\d{2}-\d{2}$/.test(iso)) ? formatDobDisplay(iso) : dobVal;
    }
    const male = card.querySelector(`input[type="radio"][data-pax="${paxIndex}"][data-field="gender"][value="male"]`);
    const female = card.querySelector(`input[type="radio"][data-pax="${paxIndex}"][data-field="gender"][value="female"]`);
    let genderText = "—";
    if (male?.checked) genderText = "Male";
    if (female?.checked) genderText = "Female";
    if (genderEl) genderEl.textContent = genderText;
    if (dobEl) dobEl.textContent = `DOB ${dobDisplay || "—"}`;
  }

  function wirePassengerAccordion(paxCount){
    expandedPassengerIndex = 0;
    const cards = root.querySelectorAll(".baPaxCard[data-pax-card]");
    cards.forEach(card => {
      const idx = Number(card.getAttribute("data-pax-card"));
      updatePaxSummary(idx);
      card.addEventListener("click", () => {
        if (card.classList.contains("is-collapsed")){
          setExpandedPassenger(idx);
        }
      });
      const toggle = card.querySelector(".baPaxCard__toggle");
      if (toggle){
        toggle.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (idx !== expandedPassengerIndex) setExpandedPassenger(idx);
        });
      }
    });
    setExpandedPassenger(expandedPassengerIndex);
  }

  // ---------- passenger autosave ----------
  function showPaxToast(text, ok=true){
    let el = document.getElementById("baPaxToast");
    if (!el){
      el = document.createElement("div");
      el.id = "baPaxToast";
      el.style.cssText = `
        position:fixed; right:14px; bottom:92px; z-index:99999;
        max-width:340px; padding:10px 12px; border-radius:10px;
        background:${ok ? "#0b6b2f" : "#b00020"}; color:#fff;
        font-weight:800; font-family:system-ui; box-shadow:0 10px 24px rgba(0,0,0,.18);
        opacity:0; transform:translateY(8px); transition:.18s ease;
      `;
      document.body.appendChild(el);
    }
    el.textContent = text;
    el.style.background = ok ? "#0b6b2f" : "#b00020";
    requestAnimationFrame(() => { el.style.opacity = "1"; el.style.transform="translateY(0)"; });
    clearTimeout(el._t);
    el._t = setTimeout(() => {
      el.style.opacity = "0"; el.style.transform="translateY(8px)";
    }, 2200);
  }

  async function savePassengerField(public_id, paxIndex, patch){
    const res = await fetch(UPDATE_PAX, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({
        public_id,
        pax_index: paxIndex,
        patch
      })
    });
    const out = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(out?.error || ("HTTP " + res.status));
    return out;
  }

  function wirePassengerAutosave(public_id, paxCount){
    // live validation on input
    root.querySelectorAll('.baBoxInput[data-pax][data-field]').forEach(inp => {
      const paxIndex = Number(inp.getAttribute("data-pax"));
      const field = inp.getAttribute("data-field");
      inp.addEventListener("input", () => {
        validatePassengerBlock(paxIndex);
        if (field === "first_name" || field === "last_name" || field === "date_of_birth") {
          updatePaxSummary(paxIndex);
        }
      });
      inp.addEventListener("change", () => {
        validatePassengerBlock(paxIndex);
        if (field === "first_name" || field === "last_name" || field === "date_of_birth") {
          updatePaxSummary(paxIndex);
        }
      });
    });
    root.querySelectorAll('input[type="radio"][data-pax][data-field="gender"]').forEach(r => {
      r.addEventListener("change", () => validatePassengerBlock(Number(r.getAttribute("data-pax"))));
    });

    // Debounce per passenger
    const paxTimers = new Map();
    const paxPending = new Map(); // paxIndex -> patch

    function queuePaxSave(paxIndex, patch){
      const cur = paxPending.get(paxIndex) || {};
      Object.assign(cur, patch);
      paxPending.set(paxIndex, cur);

      if (paxTimers.get(paxIndex)) clearTimeout(paxTimers.get(paxIndex));
      paxTimers.set(paxIndex, setTimeout(async () => {
        const payload = paxPending.get(paxIndex);
        paxPending.delete(paxIndex);

        // If local validation fails, do not try to save yet
        const localOk = validatePassengerBlock(paxIndex);
        if (!localOk){
          showPaxToast("Fix highlighted fields to continue.", false);
          return;
        }

        try{
          await savePassengerField(public_id, paxIndex, payload);
          showPaxToast("Saved passenger changes ✅", true);

          // if saved ok, ensure validation is clean
          validatePassengerBlock(paxIndex);
        }catch(e){
          showPaxToast("Could not save changes: " + (e?.message || e), false);

          // mark involved fields invalid (server complained)
          // if we can map, mark those fields; otherwise mark all required ones for that pax
          const keys = Object.keys(payload || {});
          if (!keys.length){
            validatePassengerBlock(paxIndex);
          } else {
            for (const k of keys){
              const el = root.querySelector(`.baBoxInput[data-pax="${paxIndex}"][data-field="${k}"]`);
              if (el) setFieldInvalid(el, true);
              if (k === "gender"){
                const box = root.querySelector(`.baPaxCard[data-pax-card="${paxIndex}"] .baPaxGender`);
                if (box) box.classList.add("is-invalid");
              }
            }
          }
        }
      }, 450));
    }

    // Date picker buttons: trigger calendar
    root.querySelectorAll('.baDatePickerBtn').forEach(btn => {
      const paxIndex = Number(btn.getAttribute("data-pax"));
      const hiddenDateInput = root.querySelector(`.baDatePicker[data-pax="${paxIndex}"]`);
      const visibleTextInput = root.querySelector(`.baBoxInput[data-pax="${paxIndex}"][data-field="date_of_birth"]`);
      
      if (!hiddenDateInput || !visibleTextInput) return;
      
      // Sync visible text to hidden date input value
      function syncToHiddenDate() {
        const textValue = visibleTextInput.value.trim();
        if (textValue) {
          const isoDate = parseDobInput(textValue);
          if (isoDate && /^\d{4}-\d{2}-\d{2}$/.test(isoDate)) {
            hiddenDateInput.value = isoDate;
          }
        } else if (visibleTextInput.value === "") {
          hiddenDateInput.value = "";
        }
      }
      
      // Sync hidden date input change to visible text (formatted)
      hiddenDateInput.addEventListener("change", () => {
        if (hiddenDateInput.value) {
          const formatted = formatDobDisplay(hiddenDateInput.value);
          if (formatted) {
            visibleTextInput.value = formatted;
            // Trigger validation and save
            validatePassengerBlock(paxIndex);
            const isoDate = parseDobInput(formatted);
            queuePaxSave(paxIndex, { date_of_birth: isoDate || null });
            updatePaxSummary(paxIndex);
          }
        }
      });
      
      // Click on calendar button or text input opens calendar
      function openCalendar() {
        syncToHiddenDate();
        hiddenDateInput.showPicker ? hiddenDateInput.showPicker() : hiddenDateInput.click();
      }
      
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        openCalendar();
      });
      
      // Also make the text input clickable to open calendar
      visibleTextInput.addEventListener("click", () => {
        openCalendar();
      });
      
      // Sync on initial load
      syncToHiddenDate();
    });

    // Title case formatter for names
    function toTitleCase(str) {
      if (!str) return "";
      return str.split(/\s+/).map(word => {
        if (!word) return word;
        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
      }).join(" ");
    }

    // Text/date inputs: save on blur/change
    root.querySelectorAll('.baBoxInput[data-pax][data-field]').forEach(inp => {
      const paxIndex = Number(inp.getAttribute("data-pax"));
      const field = inp.getAttribute("data-field");
      
      // Skip date_of_birth - handled by date picker above
      if (field === "date_of_birth") return;

      // Auto-capitalize name fields on input/blur
      if (field === "first_name" || field === "last_name" || field === "middle_name") {
        inp.addEventListener("input", () => {
          const current = inp.value;
          const cursorPos = inp.selectionStart;
          // Don't format while typing, just on blur
        });
        inp.addEventListener("blur", () => {
          const formatted = toTitleCase(inp.value);
          if (formatted !== inp.value) {
            inp.value = formatted;
          }
          if (field === "first_name" || field === "last_name") {
            updatePaxSummary(paxIndex);
          }
        });
      }

      // Phone formatting
      if (field === "phone") {
        inp.addEventListener("input", () => {
          // Only allow digits, limit to 10
          const digits = inp.value.replace(/\D/g, "").slice(0, 10);
          inp.value = digits;
        });
        inp.addEventListener("blur", () => {
          const digits = inp.value.replace(/\D/g, "");
          // Ensure +1 is always present in stored value
          if (digits.length === 10) {
            inp.value = digits; // Display only digits
          } else if (digits.length === 0) {
            inp.value = ""; // Allow empty for validation
          }
        });
      }

      const handler = () => {
        let v = inp.value;

        if (field === "email") v = String(v || "").trim().toLowerCase();
        if (field === "phone") {
          const digits = String(v || "").replace(/\D/g, "");
          // Normalize to +1XXXXXXXXXX format for storage
          v = digits.length === 10 ? normalizePhone("+1" + digits) : null;
        }
        if (field === "first_name" || field === "last_name" || field === "middle_name") {
          v = toTitleCase(String(v || "").trim());
        }

        // immediate validate UI
        validatePassengerBlock(paxIndex);

        queuePaxSave(paxIndex, { [field]: v || null });
      };

      inp.addEventListener("blur", handler);
      inp.addEventListener("change", handler);
    });

    // Gender radios: save on change
    root.querySelectorAll('input[type="radio"][data-pax][data-field="gender"]').forEach(r => {
      r.addEventListener("change", () => {
        if (!r.checked) return;
        const paxIndex = Number(r.getAttribute("data-pax"));
        validatePassengerBlock(paxIndex);
        queuePaxSave(paxIndex, { gender: r.value });
        updatePaxSummary(paxIndex);
      });
    });

    // initial validation pass
    validateAllPassengers(paxCount);
  }

  // ---------- main render ----------
  function renderSession(data){
    if (data.paid_at || data.status === "paid") {
      renderPaid(data);
      return;
    }

    const tipPresets = Array.isArray(data.tip_presets) ? data.tip_presets : [];
    const journeys = Array.isArray(data.journeys) ? data.journeys : [];

    const isExpired =
      data.status === "expired" ||
      (data.ui && data.ui.reason_disabled === "expired") ||
      (data.expires_at && new Date(data.expires_at).getTime() <= Date.now());

    const selectionLocked = !!(data.ui && data.ui.selection_locked);

    // Store agent data (available for future UI display)
    const agentName = data.agent_name ? String(data.agent_name) : null;
    const agentPhone = data.agent_phone ? String(data.agent_phone) : null;
    
    // Agent photo URLs
    const agentPhotoUrl = agentName === "Jake" 
      ? "https://github.com/Business-Airfare/site-assets/blob/main/jake.png?raw=true"
      : agentName === "Melinda"
      ? "https://raw.githubusercontent.com/Business-Airfare/site-assets/refs/heads/main/melinda.jpg"
      : null;

    // Selection UI values from backend (mutable)
    let careSelected = !!(data.selection && data.selection.care_selected);
    let tipMode = String(data.selection?.tip_mode || "none");
    
    // Acceptance state tracking (update global variables declared above)
    acceptanceCompleted = !!(data.acceptance && data.acceptance.acceptance_completed);
    acceptanceInProgress = false;
    const termsUrl = data.acceptance?.terms_url || "https://www.business-airfare.com/payment-terms";
    let tipPresetLabel = data.selection?.tip_preset_label ? String(data.selection.tip_preset_label) : "";
    let tipAmount = Number(data.selection?.tip_amount ?? 0) || 0;
    let tipAgreed = (Number(tipAmount) || 0) > 0;
    // tipSaveError is declared in global scope above for validateBillingUI() access

    const tipMin = 0;
    const tipMax = 100000; // $1000

    // IMPORTANT: keep original payable math for Stripe
    const ticketCents = Number(data.quote?.ticket ?? 0) || 0;
    const serviceCents = Number(data.quote?.service ?? 0) || 0;
    const careCents = Number(data.quote?.care ?? 0) || 0;

    function baseTicketService(){ return ticketCents + serviceCents; }
    function selectedTipAmount(){
      return Number(tipAmount) || 0;
    }
    function resolvedPreset(){
      return tipPresets.find(p => String(p.label) === String(tipPresetLabel || "")) || null;
    }
    function resolvedPresetAmount(){
      const preset = resolvedPreset();
      const amount = preset ? Number(preset.amount) : 0;
      return Number.isFinite(amount) ? Math.round(amount) : 0;
    }
    function appliedTipAmount(){
      if (!tipAgreed) return 0;
      if (tipMode === "preset") return resolvedPresetAmount();
      return selectedTipAmount();
    }
    function payableTotalCents(){
      const base = baseTicketService();
      const care = careSelected ? careCents : 0;
      const tip = appliedTipAmount();
      return base + care + tip;
    }

    // PER-PASSENGER DISPLAY price for sticky bar:
    // Use admin-provided "price per passenger" if your session includes it.
    // We will not guess a new backend field name — we try a safe list and fallback to ticket+service / paxCount.
    function pickPerPassengerCents(){
      const candidates = [
        data.quote?.per_passenger_total,
        data.quote?.per_passenger,
        data.quote?.price_per_passenger,
        data.quote?.pp_total,
        data.price_per_passenger,
        data.per_passenger_price,
        data.ui?.price_per_passenger
      ].filter(v => typeof v === "number" && Number.isFinite(v) && v >= 0);

      if (candidates.length) return candidates[0];

      // fallback: compute from ticket + service fee only (NOT including TCS or tip) / paxCount
      const pdArr = getPassengerDetailsArray(data);
      const paxCountFallback =
        (pdArr && pdArr.length) ? pdArr.length :
        (Array.isArray(data.passengers) && data.passengers.length) ? data.passengers.length :
        1;

      return Math.round(baseTicketService() / Math.max(1, paxCountFallback));
    }

    // First airline for sticky bar (logo + name)
    let firstCarrier = "";
    if (journeys[0] && Array.isArray(journeys[0].segments) && journeys[0].segments[0]) {
      firstCarrier = String(journeys[0].segments[0].marketing_carrier || "");
    }
    const stickyLogo = firstCarrier ? logoUrl(firstCarrier) : "";
    const airlineNameFromMap = firstCarrier ? AIRLINE_NAMES[firstCarrier.toUpperCase()] : "";
    // Only show airline name if we have a full name (not just carrier code/initials)
    const stickyAirlineName = (airlineNameFromMap && airlineNameFromMap !== firstCarrier) ? airlineNameFromMap : "";

    function applyTipHighlights(){
      const btns = Array.from(document.querySelectorAll(".baTipBtn"));
      btns.forEach(b => {
        const mode = b.getAttribute("data-mode");
        const label = b.getAttribute("data-label");
        const amount = Number(b.getAttribute("data-amount") || 0);

        let active = false;
        if (tipMode === "none" && mode === "none") active = true;
        if (tipMode === "preset" && mode === "preset" && label === tipPresetLabel && amount === tipAmount) active = true;
        b.classList.toggle("is-active", active);
      });
    }

    let bannerHtml = "";
    if (isExpired){
      bannerHtml = `
        <div class="baBanner baBanner--bad">
          <div class="baBanner__t">This payment link has expired</div>
          <div class="baBanner__b">You can still view the itinerary, but payment is disabled. Please contact your agent for a new link.</div>
        </div>
      `;
    } else if (selectionLocked){
      bannerHtml = `
        <div class="baBanner baBanner--warn">
          <div class="baBanner__t">Payment started</div>
          <div class="baBanner__b">Selection is now locked while payment is in progress.</div>
        </div>
      `;
    }

    // ----------------------------
    // FLIGHTS
    // ----------------------------
    function journeyCardHtml(j){
      const segs = Array.isArray(j?.segments) ? j.segments : [];
      if (!segs.length) return "";

      const first = segs[0];
      const departDay = first?.depart_local ? String(first.depart_local).slice(0,10) : "";
      const headerDate = departDay ? dateHeaderLabel(departDay) : "—";

      const cp = cityPairFromJourney(j);
      const routeTitle = (cp.fromCity && cp.toCity)
        ? `${escapeHtml(cp.fromCity)} <span class="baArr">→</span> ${escapeHtml(cp.toCity)}`
        : `${escapeHtml(cp.fromIata || "—")} <span class="baArr">→</span> ${escapeHtml(cp.toIata || "—")}`;

      const travelTime = minsToHM(j.total_travel_minutes);
      
      // Find first segment with next-day arrival to determine which subsequent segments to highlight
      let firstNextDayIdx = -1;
      for (let i = 0; i < segs.length; i++) {
        const s = segs[i];
        const depDate = (s.depart_local || "").slice(0,10);
        const arrDate = (s.arrive_local || "").slice(0,10);
        if (depDate && arrDate && depDate !== arrDate) {
          firstNextDayIdx = i;
          break;
        }
      }

      return `
        <article class="baCard">
          <header class="baCard__head">
            <div class="baCard__headL">
              <div class="baCard__route">${routeTitle}</div>
              <div class="baCard__date">${escapeHtml(headerDate)}</div>
            </div>
            <div class="baCard__tt">Travel time: ${escapeHtml(travelTime)}</div>
          </header>

          <div class="baFlights">
            ${segs.map((s, idx) => {
              const carrier = s.marketing_carrier || "";
              // Use cabin from backend if available, otherwise fall back to cabinFromClass
              const cabin = s.cabin ? formatCabinName(s.cabin) : cabinFromClass(s.booking_class, carrier);

              const depTime = fmt12(s.depart_local);
              const arrTime = fmt12(s.arrive_local);
              const depMD = monthDayLabel(s.depart_local);
              const arrMD = monthDayLabel(s.arrive_local);

              // Highlight all segments from the first one with next-day arrival onwards
              const shouldHighlight = firstNextDayIdx >= 0 && idx >= firstNextDayIdx;

              const flightTime = segmentFlightTime(s);
              const meal = segmentMealText(s);

              const flightNo = `${String(carrier)} ${String(s.flight_number || "").trim()}`.trim();
              const operator = String(s.operating_carrier_name || s.operating_carrier || s.operator || "").trim();

              const lo = (Array.isArray(j.layovers) && j.layovers[idx]) ? j.layovers[idx] : null;

              return `
                <div class="baFlightBlock">
                  <div class="baFlight">
                    <div class="baFlight__main">
                      <div class="baTL" aria-hidden="true">
                        <span class="baTL__dot"></span>
                        <span class="baTL__chev"></span>
                        <span class="baTL__chev"></span>
                        <span class="baTL__chev"></span>
                        <span class="baTL__dot baTL__dot--end"></span>
                      </div>

                      <div class="baLeft">
                        <div class="baRow">
                          <div class="baTimeLine">
                            <span class="baTime">${escapeHtml(depTime)}</span>
                            <span class="baMD">${escapeHtml(depMD)}</span>
                          </div>
                          <div class="baLocLine">
                            <span class="baCity">${escapeHtml(s.origin_city || "")},</span>
                            <span class="baIata">${escapeHtml(s.origin || "")}</span>
                          </div>
                        </div>

                        <div class="baRow baRow--meta">
                          ${flightTime ? `<div class="baMetaRow">${escapeHtml(flightTime)}</div>` : ``}
                          ${meal ? `<div class="baMetaRow"><span class="baFork">🍴</span>${escapeHtml(meal)}</div>` : ``}
                        </div>

                        <div class="baRow" style="margin-top:10px">
                          <div class="baTimeLine">
                            <span class="baTime">${escapeHtml(arrTime)}</span>
                            <span class="baMD ${shouldHighlight ? 'baMD--nextDay' : ''}">${escapeHtml(arrMD)}</span>
                          </div>
                          <div class="baLocLine">
                            <span class="baCity">${escapeHtml(s.destination_city || "")},</span>
                            <span class="baIata">${escapeHtml(s.destination || "")}</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="baAir">
                      ${carrier ? `
                        <img class="baAir__logo" src="${logoUrl(carrier)}" alt="${escapeHtml(carrier)}" onerror="this.style.display='none'">
                      ` : ""}
                      <div class="baAir__meta">
                        <span class="baAir__fn">${escapeHtml(flightNo || carrier || "")}</span>
                        <span class="baAir__sep">|</span>
                        <span class="baAir__cab">${escapeHtml(cabin || ("Class " + (s.booking_class || "")))}</span>
                      </div>
                      ${operator ? `<div class="baAir__op">${escapeHtml(operator)}</div>` : ``}
                    </div>
                  </div>

                  ${lo ? `
                    <div class="baLayRow">
                      <div class="baLayRow__text">
                        <span class="baLayRow__dur">${escapeHtml(minsToHM(lo.minutes))} layover</span>
                        <span class="baLayRow__in"> in ${escapeHtml(lo.at_city || lo.at || "")}</span>
                      </div>
                    </div>
                  ` : ``}
                </div>
              `;
            }).join("")}
          </div>
        </article>
      `;
    }

    // ----------------------------
    // PASSENGERS UI
    // ----------------------------
    function passengerBlockHtml(idx){
      const pax = getPassengerFromSession(data, idx);
      const genderName = `baGender_${idx}`;
      const displayFirst = pax.first_name || "Passenger";
      const displayLast = pax.last_name || String(idx + 1);
      const displayDob = pax.dobISO ? formatDobDisplay(pax.dobISO) : "";
      const displayGender = pax.gender ? (pax.gender === "male" ? "Male" : "Female") : "—";
      const paxNumber = idx + 1;

      return `
        <div class="baPaxCard ${idx === 0 ? "is-expanded" : "is-collapsed"}" data-pax-card="${idx}">
          <div class="baPaxCard__head">
            <div class="baPaxCard__title">
              Passenger <span class="baPaxHeadNum">${paxNumber}</span>
            </div>
            <div class="baPaxHeadRight">
              <span class="baPaxHeadNote">check this passenger's details <span class="baReq">*</span></span>
              <button type="button" class="baPaxCard__toggle" aria-label="Expand passenger details">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path d="M9 3H3v6M3 3l7 7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M15 21h6v-6M21 21l-7-7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="baPaxCard__summary">
            <div class="baPaxSummaryName" data-pax-summary-name>
              <span class="baPaxSummaryFirst" data-pax-summary-first>${escapeHtml(displayFirst)}</span>
              <span class="baPaxSummaryNameDivider" aria-hidden="true"></span>
              <span class="baPaxSummaryLast" data-pax-summary-last>${escapeHtml(displayLast)}</span>
            </div>
            <div class="baPaxSummaryMeta" data-pax-summary-meta>
              <span class="baPaxSummaryGender" data-pax-summary-gender>${escapeHtml(displayGender)}</span>
              <span class="baPaxSummaryDot">·</span>
              <span class="baPaxSummaryDob" data-pax-summary-dob>DOB ${escapeHtml(displayDob || "—")}</span>
            </div>
          </div>

          <div class="baPaxCard__details">
            <div class="baPaxGrid">
            <div class="baPaxGender">
              <div class="baLbl">Gender<span class="baReq">*</span></div>
              <div class="baRadioRow">
                <label class="baRadio">
                  <input type="radio" name="${genderName}" value="male" data-pax="${idx}" data-field="gender" ${pax.gender==="male" ? "checked" : ""}>
                  <span>Male</span>
                </label>
                <label class="baRadio">
                  <input type="radio" name="${genderName}" value="female" data-pax="${idx}" data-field="gender" ${pax.gender==="female" ? "checked" : ""}>
                  <span>Female</span>
                </label>
              </div>
            </div>

            <div class="baPaxHelp">
              The passenger names must match the travel documents. Name changes are not allowed.
            </div>

            <div class="baField">
              <label class="baLbl">Last name<span class="baReq">*</span></label>
              <input class="baBoxInput" value="${escapeHtml(pax.last_name)}" data-pax="${idx}" data-field="last_name" placeholder="Last name">
              <div class="baErr">Please enter a valid last name.</div>
            </div>

            <div class="baField">
              <label class="baLbl">First name<span class="baReq">*</span></label>
              <input class="baBoxInput" value="${escapeHtml(pax.first_name)}" data-pax="${idx}" data-field="first_name" placeholder="First name">
              <div class="baErr">Please enter a valid first name.</div>
            </div>

            <div class="baField">
              <label class="baLbl">Middle name <span style="font-weight:600;opacity:.7">(optional)</span></label>
              <input class="baBoxInput" value="${escapeHtml(pax.middle_name)}" data-pax="${idx}" data-field="middle_name" placeholder="Middle name">
              <div class="baErr">Invalid value.</div>
            </div>

            <div class="baField">
              <label class="baLbl">Date of Birth<span class="baReq">*</span></label>
              <div class="baDateInputWrapper">
                <input class="baBoxInput" type="text" value="${escapeHtml(pax.dobISO ? formatDobDisplay(pax.dobISO) : "")}" data-pax="${idx}" data-field="date_of_birth" placeholder="01-Jan-1980" readonly>
                <input type="date" class="baDatePicker" data-pax="${idx}" data-field="date_of_birth_hidden" value="${escapeHtml(pax.dobISO || "")}" style="position:absolute;opacity:0;pointer-events:none;width:1px;height:1px;overflow:hidden;">
                <button type="button" class="baDatePickerBtn" data-pax="${idx}" aria-label="Open date picker">
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M6 2V4M14 2V4M3 8H17M4 4H16C17.1046 4 18 4.89543 18 6V16C18 17.1046 17.1046 18 16 18H4C2.89543 18 2 17.1046 2 16V6C2 4.89543 2.89543 4 4 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M6 12H6.01M9 12H9.01M12 12H12.01M6 15H6.01M9 15H9.01M12 15H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
              <div class="baErr">Please enter a valid date of birth.</div>
            </div>

            <div class="baField">
              <label class="baLbl">Email<span class="baReq">*</span></label>
              <input class="baBoxInput" value="${escapeHtml(pax.email)}" data-pax="${idx}" data-field="email" placeholder="Email">
              <div class="baErr">Please enter a valid email.</div>
            </div>

            <div class="baField">
              <label class="baLbl">Phone<span class="baReq">*</span></label>
              <div class="baPhoneWrapper" style="display:flex;border:1px solid #e7e7e7;border-radius:6px;overflow:hidden;background:#fff;box-sizing:border-box">
                <div style="padding:10px 12px;background:#f7f7f7;border-right:1px solid #e7e7e7;font-weight:700;flex-shrink:0;font-size:15px;line-height:1;display:flex;align-items:center;box-sizing:border-box">+1</div>
                <input class="baBoxInput" value="${escapeHtml(pax.phone && pax.phone.startsWith('+1') ? pax.phone.slice(2) : (pax.phone || ''))}" data-pax="${idx}" data-field="phone" placeholder="5555555555" style="border:0;flex:1;padding:10px 12px;font-size:15px;font-weight:700;box-sizing:border-box;margin:0;height:auto;line-height:normal">
              </div>
              <div class="baErr">Please enter a valid phone number.</div>
            </div>
            </div>
          </div>
        </div>
      `;
    }

    const pdArr = getPassengerDetailsArray(data);
    const paxCount =
      (pdArr && pdArr.length) ? pdArr.length :
      (Array.isArray(data.passengers) && data.passengers.length) ? data.passengers.length :
      1;

    // sticky per pax display
    const perPaxCents = pickPerPassengerCents();

    root.innerHTML = `
<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  :root{
    --ba-bg: #f5f5f5;
    --ba-card: #ffffff;
    --ba-border: #e9e9e9;
    --ba-text: #111;
    --ba-accent: #d1ad54;
    --ba-danger: #d92d20;
    --ba-danger-bg: rgba(217,45,32,.06);
  }
  #baPayRoot{
    width: 100%;
    margin: 0;
    padding: 0;
  }
  body{
    margin: 0;
    padding: 0;
  }
  html{
    margin: 0;
    padding: 0;
  }

  /* Header */
  .baHeader{
    background: #fff;
    border-bottom: 1px solid #e9e9e9;
  }
  .baHeaderTop{
    max-width: 1220px;
    margin: 0 auto;
    padding: 4px 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
  }
  .baHeaderNav{
    display: flex;
    align-items: center;
    gap: 24px;
    flex: 1;
  }
  .baHeaderNav a{
    color: #111;
    text-decoration: none;
    font-weight: 700;
    font-size: 14px;
    letter-spacing: 0.02em;
    text-transform: uppercase;
  }
  .baHeaderNav a:hover{
    opacity: 0.7;
  }
  .baHeaderRight{
    display: flex;
    align-items: center;
    gap: 24px;
  }
  .baHeaderPhone{
    font-weight: 700;
    font-size: 14px;
    color: #111;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .baHeaderPhone a{
    color: #111;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .baHeaderPhone a:hover{
    opacity: 0.8;
  }
  .baHeaderPhoneIcon{
    width: 14px;
    height: 14px;
    flex-shrink: 0;
  }
  .baHeaderAgent{
    display: flex;
    align-items: flex-start;
    gap: 8px;
  }
  .baHeaderAgentContent{
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 0;
    padding-top: 0;
    justify-content: space-between;
    height: 38px;
  }
  .baHeaderAgentLabel{
    font-size: 11px;
    font-weight: 700;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0px;
    line-height: 1;
    padding-top: 2px;
  }
  .baHeaderAgentName{
    font-weight: 700;
    font-size: 16px;
    color: #111;
    margin-top: 8px;
    margin-bottom: 0;
    line-height: 1;
  }
  .baHeaderAgentAvatar{
    width: 38px;
    height: 38px;
    border-radius: 50%;
    object-fit: cover;
    background: #f0f0f0;
    flex-shrink: 0;
  }
  .baHeaderAgentRow{
    display: flex;
    align-items: center;
    gap: 24px;
  }
  .baHeaderDivider{
    width: 1px;
    height: 24px;
    background: rgba(0,0,0,0.15);
    flex-shrink: 0;
  }
  .baHeaderProgress{
    background: #2f2f2f;
    padding: 12px 18px;
  }
  .baHeaderProgressInner{
    max-width: 1220px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 1.25fr 0.95fr;
    gap: 18px;
    align-items: center;
  }
  .baHeaderProgressLeft{
    min-width: 0;
  }
  .baHeaderProgressTitle{
    font-weight: 900;
    font-size: 20px;
    color: #fff;
    margin-bottom: 4px;
  }
  .baHeaderProgressSubtitle{
    font-size: 14px;
    color: #ccc;
    opacity: 0.9;
  }
  .baHeaderProgressSteps{
    display: flex;
    align-items: center;
    gap: 16px;
    justify-content: flex-start;
  }
  .baProgressStep{
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  .baProgressStepCircle{
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 14px;
    flex-shrink: 0;
  }
  .baProgressStepLabel{
    font-size: 11px;
    color: #fff;
    text-align: center;
    line-height: 1.2;
    white-space: nowrap;
  }
  .baProgressStepCircle.completed{
    background: var(--ba-accent);
    color: #111;
  }
  .baProgressStepCircle.active{
    background: #2f2f2f;
    border: 2px solid var(--ba-accent);
    color: var(--ba-accent);
    box-sizing: border-box;
  }
  .baProgressStepCircle.pending{
    background: #555;
    color: #fff;
  }
  .baProgressStepLine{
    width: 60px;
    height: 2px;
    background: #555;
    margin-top: 0;
  }
  .baProgressStepLine.completed{
    background: var(--ba-accent);
  }
  @media (max-width: 980px){
    .baHeaderNav{ gap: 16px; }
    .baHeaderRight{ gap: 16px; }
    .baHeaderProgressInner{ grid-template-columns: 1fr; align-items: flex-start; gap: 16px; }
    .baHeaderProgressSteps{ width: 100%; }
  }

  .baWrap{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--ba-bg);
    color: var(--ba-text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    width: 100%;
    min-height: 100vh;
  }
  .baPage{
    max-width: 1220px;
    margin: 0 auto;
    padding: 26px 18px 110px;
  }
  .baGrid{
    display:grid;
    grid-template-columns: 1.25fr 0.95fr;
    gap: 18px;
    align-items:start;
  }
  @media (max-width: 980px){
    .baGrid{ grid-template-columns:1fr; }
    .baPage{ padding-bottom: 140px; }
  }

  .baSectionTitle{
    font-family: Georgia, "Times New Roman", serif;
    font-weight: 800;
    font-size: 34px;
    margin: 0 0 14px;
    letter-spacing: -0.02em;
    line-height: 1.05;
  }
  @media (max-width: 980px){
    .baSectionTitle{ font-size: 28px; }
  }

  .baBanner{
    border-radius: 10px; padding: 12px 14px;
    border: 1px solid var(--ba-border);
    background: #fff; margin-bottom: 12px;
  }
  .baBanner--bad{ border-color:#ffd2d2; background:#fff3f3; color:#8a1f1f; }
  .baBanner--warn{ border-color:#ffe1a6; background:#fff7e6; color:#6a4b00; }
  .baBanner__t{ font-weight: 900; margin-bottom: 2px; }
  .baBanner__b{ opacity:.9; font-weight: 650; }

  .baCard{
    background: var(--ba-card);
    border: 1px solid var(--ba-border);
    border-radius: 10px;
    overflow:hidden;
    margin-bottom: 16px;
    box-shadow: 0 10px 24px rgba(0,0,0,.05);
  }
  .baCard__head{
    display:flex;
    justify-content:space-between;
    gap: 12px;
    align-items:flex-start;
    padding: 18px 20px 14px;
    border-bottom: 1px solid #efefef;
  }
  .baCard__route{
    font-family: Georgia, "Times New Roman", serif;
    font-weight: 800;
    font-size: 26px;
    letter-spacing: -0.02em;
    line-height: 1.1;
  }
  .baArr{ margin: 0 10px; }
  .baCard__date{
    margin-top: 8px;
    font-size: 15px;
    opacity: .75;
    font-weight: 650;
  }
  .baCard__tt{
    font-size: 13px;
    opacity:.75;
    font-weight: 700;
    white-space:nowrap;
    padding-top: 8px;
    margin-right: 20px;
  }

  .baFlights{ padding: 8px 0; }
  .baFlightBlock{ padding: 0 20px; }

  .baFlight{
    display:grid;
    grid-template-columns: 1fr 250px;
    gap: 16px;
    padding: 16px 0;
    border-top: 1px solid #f1f1f1;
  }
  .baFlightBlock:first-child .baFlight{ border-top: 0; }

  .baFlight__main{
    display:grid;
    grid-template-columns: 22px 1fr;
    gap: 14px;
    align-items:flex-start;
    min-width:0;
  }

  .baTL{
    width: 22px;
    margin-top: 6px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap: 7px;
    opacity:.8;
  }
  .baTL__dot{
    width: 10px; height: 10px; border-radius: 50%;
    background: #d0d0d0;
  }
  .baTL__dot--end{
    background:#fff;
    border: 2px solid #d0d0d0;
    width: 10px; height: 10px;
  }
  .baTL__chev{
    width: 8px; height: 6px;
    border-left: 2px solid #d7d7d7;
    border-bottom: 2px solid #d7d7d7;
    transform: rotate(-45deg);
    margin-left: 1px;
  }

  /* move cities closer to times */
  .baRow{
    display:grid;
    grid-template-columns: 150px 1fr;
    gap: 10px;
    align-items:baseline;
    min-width:0;
  }

  .baTimeLine{
    display:flex;
    align-items:baseline;
    gap: 10px;
    min-width:0;
  }
  .baTime{
    font-size: 16px;
    font-weight: 800;
    line-height: 1.1;
    white-space:nowrap;
  }
  .baMD{
    font-size: 13px;
    font-weight: 700;
    opacity:.65;
    white-space:nowrap;
  }
  .baMD--nextDay{
    color: #c56a00;
    opacity: 0.85;
  }

  .baLocLine{
    font-size: 15px;
    font-weight: 800;
    line-height: 1.2;
    min-width:0;
    white-space:normal;
    word-wrap: break-word;
  }
  .baCity{
    display: inline;
  }
  .baIata{
    font-weight: 800;
    text-decoration: none;
    margin-left: 5px;
    opacity: .85;
    display: inline;
  }

  /* flight time smaller */
  .baRow--meta{
    margin-top: 10px;
    grid-template-columns: 1fr;
    gap: 6px;
  }
  .baMetaRow{
    font-size: 12px;
    font-weight: 700;
    opacity:.68;
    line-height: 1.35;
  }

  .baAir{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap: 8px;
    min-width:0;
    padding-top: 6px;
  }

  /* airline logos smaller */
  .baAir__logo{
    width: 90px;
    height: 28px;
    object-fit: contain;
  }
  .baAir__meta{
    font-size: 14px;
    opacity: .75;
    font-weight: 700;
    white-space:nowrap;
  }
  .baAir__fn{ font-weight: 800; opacity:.9; }
  .baAir__sep{ margin: 0 8px; opacity:.5; }
  .baAir__op{
    font-size: 13px;
    opacity:.6;
    font-weight: 650;
    max-width: 100%;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }

  .baLayRow{
    border-top: 1px solid #efefef;
    border-bottom: 1px solid #efefef;
    padding: 14px 0;
    margin: 0;
  }
  .baLayRow__text{
    font-size: 14px;
    font-weight: 700;
    color: #6b6b6b;
  }
  .baLayRow__dur{ font-weight: 800; color:#6b6b6b; }

  /* Passenger panel */
  .baPaxWrap{ position: sticky; top: 14px; }
  @media (max-width: 980px){ .baPaxWrap{ position: static; } }

  .baPaxCard{
    background: var(--ba-card);
    border: 1px solid var(--ba-border);
    border-radius: 10px;
    overflow:hidden;
    margin-bottom: 14px;
    box-shadow: 0 10px 24px rgba(0,0,0,.05);
  }
  .baPaxCard.is-collapsed{ cursor:pointer; }
  .baPaxCard__head{
    padding: 18px 18px;
    font-family: Georgia, "Times New Roman", serif;
    font-weight: 800;
    font-size: 26px;
    border-bottom: 1px solid #efefef;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .baPaxCard__title{ min-width: 0; }
  .baPaxHeadNum{ margin-left: 6px; font-weight: 900; }
  .baPaxHeadRight{
    display:flex;
    align-items:center;
    gap: 10px;
  }
  .baPaxHeadNote{
    margin-left: 8px;
    font-size: 12px;
    font-weight: 700;
    font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    color: #8a8a8a;
    display: none;
  }
  .baPaxCard.is-collapsed .baPaxHeadNote{
    display: inline-flex;
    color:#7b7b7b;
  }
  .baPaxCard__toggle{
    background: transparent;
    border: 0;
    padding: 4px;
    color: #8a8a8a;
    cursor: pointer;
    border-radius: 4px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .baPaxCard__toggle:hover{
    color: #4b4b4b;
    background: #f5f5f5;
  }
  .baPaxCard__summary{
    padding: 6px 18px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 14px;
    font-size: 15px;
    font-weight: 700;
    color: #4b4b4b;
    border-bottom: 1px solid #efefef;
    white-space: nowrap;
  }
  .baPaxCard.is-collapsed .baPaxCard__summary{
    border-bottom: 0;
    padding-top: 10px;
  }
  .baPaxSummaryName{
    flex: 1 1 auto;
    max-width: 65%;
    font-size: 16px;
    font-weight: 800;
    padding: 10px 12px;
    border: 1px solid #e7e7e7;
    border-radius: 6px;
    background: #fff;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    line-height: 1.1;
    gap: 10px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .baPaxCard.is-collapsed .baPaxSummaryName{
    line-height: 1.25;
    padding-bottom: 11px;
  }
  .baPaxSummaryFirst,
  .baPaxSummaryLast{
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .baPaxSummaryNameDivider{
    width: 1px;
    height: 60%;
    background: #dcdcdc;
    display: inline-block;
  }
  .baPaxSummaryMeta{
    display:flex;
    align-items:center;
    gap: 6px;
    flex: 0 1 auto;
    min-width:0;
    color:#6a6a6a;
    font-weight:600;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .baPaxSummaryGender{
    display:inline-block;
    min-width: 52px;
    text-align:center;
  }
  .baPaxSummaryDot{ opacity:.6; }
  .baPaxSummaryDob{ color:#6a6a6a; font-weight:600; }
  .baPaxCard__details{
    overflow:hidden;
    max-height: 1200px;
    transition: max-height .25s ease, opacity .2s ease;
  }
  .baPaxCard.is-collapsed .baPaxCard__details{
    max-height: 0;
    opacity: 0;
    pointer-events: none;
  }
  .baPaxCard.is-expanded .baPaxCard__summary{ display:none; }
  .baPaxCard.is-collapsed .baPaxCard__head{
    padding: 12px 18px;
    font-size: 20px;
    border-bottom: 1px solid #efefef;
  }
  @media (max-width: 620px){
    .baPaxCard__summary{ flex-direction:column; align-items:flex-start; }
  }

  .baPaxGrid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 18px;
    padding: 16px 18px 18px;
    align-items:start;
  }
  .baPaxGender{ grid-column: 1 / 2; }
  .baPaxHelp{
    grid-column: 2 / 3;
    font-size: 12px;
    font-weight: 650;
    color: #6a6a6a;
    line-height: 1.4;
    padding-top: 12px;
  }

  .baLbl{
    display:block;
    font-size: 13px;
    font-weight: 800;
    color: #707070;
    margin-bottom: 6px;
    letter-spacing: .02em;
  }
  .baReq{ color:#d18a00; font-weight: 900; margin-left: 4px; }

  .baRadioRow{
    display:flex;
    align-items:center;
    gap: 20px;
    font-size: 14px;
    font-weight: 800;
  }
  .baRadio{
    display:inline-flex;
    align-items:center;
    gap: 10px;
    user-select:none;
  }
  .baRadio input{
    width: 16px;
    height: 16px;
    accent-color: var(--ba-accent);
  }

  /* Rectangular box inputs */
  .baField{ min-width:0; position:relative; }
  .baDateInputWrapper{
    position: relative;
    display: flex;
    align-items: center;
  }
  .baDateInputWrapper .baBoxInput{
    padding-right: 42px;
  }
  .baDatePickerBtn{
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: 0;
    padding: 4px;
    cursor: pointer;
    color: #666;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: color 0.2s ease, background 0.2s ease;
  }
  .baDatePickerBtn:hover{
    color: #333;
    background: #f5f5f5;
  }
  .baDatePickerBtn:active{
    background: #e9e9e9;
  }
  .baBoxInput{
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #e7e7e7;
    border-radius: 6px;
    background: #fff;
    font-size: 15px;
    font-weight: 700;
    outline: none;
    box-sizing: border-box;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  .baBoxInput:focus{
    border-color: #bdbdbd;
    box-shadow: 0 0 0 2px rgba(0,0,0,0.04);
  }
  .baBoxInput[readonly]{
    cursor: pointer;
  }
  .baBoxInput::placeholder{
    color: #b1b1b1;
    font-weight: 650;
  }

  /* INVALID HIGHLIGHT (red) */
  .baBoxInput.is-invalid{
    border-color: var(--ba-danger) !important;
    background: var(--ba-danger-bg);
  }
  .baPhoneWrapper.is-invalid{
    border-color: var(--ba-danger) !important;
  }
  .baPaxGender.is-invalid{
    border-radius: 10px;
    padding: 10px 10px 12px;
    margin: -10px -10px 0;
    background: var(--ba-danger-bg);
    outline: 2px solid rgba(217,45,32,.35);
  }
  .baErr{
    display:none;
    margin-top: 6px;
    font-size: 12px;
    font-weight: 800;
    color: var(--ba-danger);
  }
  .baField:has(.baBoxInput.is-invalid) .baErr{ display:block; }
  .baField:has(.baPhoneWrapper.is-invalid) .baErr{ display:block; }
  .baPaxGender.is-invalid .baErr{ display:block; }

  .baInfoBanner{
    margin: 12px 0 0;
    padding: 14px 16px;
    border: 1px solid #e8e8e8;
    border-radius: 10px;
    background: #f7f5ff;
    color: #3c2f7a;
    display:flex;
    gap: 10px;
    align-items:flex-start;
    font-weight: 800;
    font-size: 16px;
    line-height: 1.35;
    box-shadow: 0 10px 24px rgba(0,0,0,.04);
  }
  .baInfoIcon{
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #3c2f7a;
    color:#fff;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size: 12px;
    margin-top: 2px;
    flex: 0 0 auto;
  }

  /* Extras */
  .baExtras{ margin-top: 16px; }
  .baPanel{
    background: var(--ba-card);
    border: 1px solid var(--ba-border);
    border-radius: 10px;
    padding: 16px;
    box-shadow: 0 10px 24px rgba(0,0,0,.04);
  }
  .baPanelTitle{ font-weight: 900; margin-bottom: 10px; }
  .baTipSection{ margin-top: 18px; }
  .baTipCard{
    background: var(--ba-card);
    border: 1px solid var(--ba-border);
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0 10px 24px rgba(0,0,0,.04);
    display: grid;
    grid-template-columns: 1fr 1.2fr;
    gap: 18px;
    align-items: start;
  }
  .baTipHeader{
    min-width: 220px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .baTipHeader .baTipAgreeWarning{
    width: calc(100% + 18px);
    margin-left: -9px;
    margin-right: -9px;
  }
  .baTipTitle{
    font-weight: 900;
    font-size: 16px;
    margin-bottom: 6px;
  }
  .baTipSubtitle{
    font-size: 13px;
    opacity: 0.7;
    line-height: 1.5;
  }
  .baTipControls{
    min-width: 240px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .baTipFooter{
    grid-column: 1 / -1;
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    justify-content: space-between;
    column-gap: 18px;
    row-gap: 0;
  }
  .baTipFooterLeft{
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0;
    margin-top: -4px;
  }
  .baTipFooterRight{
    flex: 1;
    display: flex;
    justify-content: flex-end;
  }
  .baTipRow{
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
    justify-content: flex-start;
  }
  .baTipBtn{
    padding: 7px 8px;
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #fff;
    font-weight: 800;
    font-size: 12px;
    line-height: 1.1;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s, color 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    min-width: 0;
    flex: 0 0 calc((100% - 12px) / 3);
    order: 1;
    text-align: center;
  }
  .baTipBtn--perfect{
    flex: 0 0 calc((100% - 6px) / 2);
    order: 2;
  }
  .baTipBtn--exceptional{
    flex: 0 0 calc((100% - 6px) / 2);
    order: 2;
  }
  .baTipBtn--compact{
    padding: 6px 12px;
    min-width: auto;
    height: 30px;
    gap: 2px;
  }
  .baTipBtnLabel{
    white-space: nowrap;
    font-weight: 800;
    font-size: 12px;
  }
  .baTipBtnAmount{
    font-weight: 700;
    font-size: 11px;
    opacity: 0.75;
  }
  .baTipBtn:hover{
    border-color: #bbb;
  }
  .baTipBtn.is-active{
    border-color: #111;
    background: #111;
    color: #fff;
  }
  .baTipBtn:disabled{
    opacity: 0.6;
    cursor: not-allowed;
  }
  .baTipBottomRow{
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0;
    justify-content: center;
    margin-top: auto;
    width: 100%;
  }
  .baTipCustomWrap{
    display: flex;
    align-items: center;
    gap: 0;
    height: 30px;
    padding: 0 4px;
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #fff;
    width: 78px;
    justify-content: center;
    margin: 0 3px;
  }
  .baTipCustomField{
    position: relative;
    display: flex;
    align-items: center;
  }
  .baTipCustomField::before{
    content: "$";
    position: absolute;
    left: 6px;
    font-weight: 900;
    font-size: 12px;
    opacity: 0.85;
    pointer-events: none;
    z-index: 1;
  }
  .baTipCustomBtn{
    width: 30px;
    height: 30px;
    border-radius: 50%;
    border: 1px solid #ddd;
    background: #f5f5f5;
    font-weight: 900;
    font-size: 14px;
    line-height: 1;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  .baTipBottomRow .baTipBtn--compact{
    margin-left: 10px;
  }
  .baTipCustomBtn:disabled{
    opacity: 0.6;
    cursor: not-allowed;
  }
  .baTipCustom{
    width: 100%;
    padding: 4px 4px 4px 16px;
    border-radius: 8px;
    border: 1px solid transparent;
    font-weight: 800;
    text-align: center;
    background: transparent;
  }
  .baTipCustom::-webkit-outer-spin-button,
  .baTipCustom::-webkit-inner-spin-button{
    -webkit-appearance: none;
    margin: 0;
  }
  .baTipCustom{
    -moz-appearance: textfield;
  }
  .baTipBottomRow .baTipBtn--compact{
    width: 120px;
    justify-content: center;
  }
  .baTipAgreeRow{
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--ba-border);
    background: #f7f7f9;
    margin-bottom: 0;
  }
  .baTipAgreeRow.is-warn{
    background: #fde8e8;
    border-color: #f5b5b5;
  }
  .baTipAgreeCheck{
    width: 18px;
    height: 18px;
    accent-color: var(--ba-accent);
    flex-shrink: 0;
  }
  .baTipAgreeText{
    font-size: 11px;
    font-weight: 700;
    line-height: 1.3;
  }
  .baTipAgreeWarning{
    margin-top: 1px;
    padding: 8px 10px 4px;
    border-radius: 8px;
    background: #fde8e8;
    color: #b00020;
    font-size: 11px;
    line-height: 1.4;
    display: none;
    width: 100%;
  }

  .baTermsAgreeSection{
    margin-top: 20px;
    padding: 16px;
    border-radius: 10px;
    border: 1px solid transparent;
    background: #fff;
    transition: all 0.2s ease;
  }
  .baTermsAgreeSection.is-warn{
    background: #FDE8E8;
    border-color: #D0A7A7;
  }
  .baTermsAgreeLabel{
    display: flex;
    align-items: flex-start;
    gap: 10px;
    cursor: pointer;
  }
  .baTermsAgreeCheck{
    margin-top: 3px;
    width: 18px;
    height: 18px;
    flex-shrink: 0;
    cursor: pointer;
    accent-color: #d1ad54;
  }
  .baTermsAgreeSection.is-warn .baTermsAgreeCheck{
    border: 2px solid #C34A4A;
  }
  .baTermsAgreeText{
    font-size: 13px;
    line-height: 1.6;
    color: #333;
  }
  .baTermsLink{
    color: #0000FF;
    text-decoration: underline;
    cursor: pointer;
  }
  .baTermsAgreeWarning{
    margin-top: 12px;
    padding: 10px;
    background: #C34A4A;
    color: #fff;
    text-align: center;
    font-size: 13px;
    font-weight: 600;
    border-radius: 6px;
    display: none;
  }
  .baTermsAgreeSection.is-warn .baTermsAgreeWarning{
    display: block;
    box-sizing: border-box;
    flex: 0 0 100%;
  }
  .baTipHelper{
    font-size: 12px;
    opacity: 0.7;
  }
  @media (max-width: 720px){
    .baTipCard{ flex-direction: column; }
    .baTipControls{ width: 100%; }
    .baTipBottomRow{ flex-wrap: wrap; }
  }

  /* Sticky bottom bar (updated per request) */
  .baSticky{
    position:fixed; left:0; right:0; bottom:0; z-index:9999;
    background:#2f2f2f; color:#fff;
    padding: 10px 14px;
    box-shadow: 0 -8px 22px rgba(0,0,0,.18);
  }
  .baStickyIn{
    max-width: 1220px;
    margin: 0 auto;
    display:flex;
    gap: 14px;
    align-items:center;
    justify-content:space-between;
  }
  .baStickyLeft{
    display:flex; gap: 12px; align-items:center; min-width:0; margin-left: 40px;
  }
  .baStickyMessage{
    font-weight: 700;
    font-size: 14px;
    color: #fff;
    opacity: 0.9;
    display: flex;
    align-items: center;
    gap: 4px;
    position: relative;
  }
  .baStickyMessageText{
    flex-shrink: 0;
  }
  @media (max-width: 768px){
    .baStickyMessage{ display: none; }
  }
  .baStickyLogo{
    width: 96px; height: 44px; border-radius: 8px; background:#fff;
    display:flex; align-items:center; justify-content:center; overflow:hidden;
    flex-shrink: 0;
    padding: 0 20px;
    box-sizing: border-box;
  }
  .baStickyLogo img{ width: 56px; height: 32px; object-fit:contain; }

  .baStickyRight{ display:flex; gap: 14px; align-items:center; }

  .baStickyPrice{ text-align:right; line-height: 1.05; }
  .baStickyPriceTop{ display:flex; justify-content:flex-end; gap: 10px; align-items:baseline; }
  .baStickyAmt{ font-weight: 1000; font-size: 24px; }
  .baStickyCur{ opacity:.85; font-weight: 900; font-size: 12px; }

  /* updated label */
  .baStickySub{ opacity:.82; font-weight: 800; font-size: 12px; margin-top: 2px; }
  .baStickySmall{ display:none !important; }

  /* CTA: single label "BOOK" + timer on right */
  .baCTA{
    border: 0;
    border-radius: 8px;
    background: var(--ba-accent);
    color: #111;
    font-weight: 1000;
    letter-spacing: .01em;
    padding: 10px 18px;
    display:flex;
    align-items:center;
    gap: 10px;
    cursor:pointer;
    min-width: auto;
    justify-content: space-between;
  }
  .baCTA[disabled]{ opacity:.55; cursor:not-allowed; }

  .baCTATitle{ font-weight:1000; font-size: 16px; text-align: center; padding: 0 8px; }
  .baCTARight{
    font-weight: 1000;
    font-variant-numeric: tabular-nums;
    padding-left: 10px;
    border-left: 1px solid rgba(0,0,0,.25);
    flex-shrink: 0;
  }

  @media (max-width: 560px){
    .baSectionTitle{ font-size: 24px; }
    .baRow{ grid-template-columns: 1fr; }
    .baAir{ align-items:flex-start; }
    .baFlight{ grid-template-columns: 1fr; }
    .baCTA{ padding: 10px 10px; }
    .baCTATitle{ padding: 0 6px; }
  }

  /* Optional Services Two-Column Layout */
  .baExtrasGrid{
    display: grid;
    grid-template-columns: 1.25fr 0.95fr;
    gap: 18px;
    align-items: start;
  }
  @media (max-width: 980px){
    .baExtrasGrid{ grid-template-columns: 1fr; display: flex; flex-direction: column; }
    .baExtrasLeft{ display: contents; }
    .baExtrasRight{ display: contents; }
    .baCareBox{ order: 1; }
    .baTipSection{ order: 2; }
    .baSummaryBox{ order: 3; }
    .baExtrasStripe{ order: 4; }
  }

  /* Travel Care Service Box */
  .baCareBox{
    background: #faf9f6;
    border: 1px solid var(--ba-border);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 10px 24px rgba(0,0,0,.05);
  }
  .baCareBox__header{
    background: #4a4a4a;
    padding: 16px 20px;
    color: #fff;
  }
  .baCareBox__headerLeft{
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  .baCareBox__icon{
    width: 24px;
    height: 24px;
    flex-shrink: 0;
    color: #fff;
    margin-top: 2px;
  }
  .baCareBox__titleWrap{
    flex: 1;
  }
  .baCareBox__title{
    font-weight: 900;
    font-size: 22px;
    margin-bottom: 4px;
  }
  .baCareBox__subtitle{
    font-size: 13px;
    opacity: 0.85;
    line-height: 1.4;
  }
  .baCareBox__content{
    padding: 20px;
  }
  .baCareBox__benefits{
    display: flex;
    flex-direction: column;
    gap: 18px;
  }
  .baCareBox__benefit{
    display: flex;
    align-items: flex-start;
    gap: 10px;
    font-size: 14px;
    line-height: 1.5;
  }
  .baCareBox__check{
    color: #0b6b2f;
    font-weight: 900;
    flex-shrink: 0;
    margin-top: 2px;
  }
  .baCareBox__benefitText{
    flex: 1;
    min-width: 0;
  }
  .baCareBox__benefitTitle{
    font-size: 18px;
    line-height: 1.4;
    font-weight: 700;
  }
  .baCareBox__benefitSub{
    font-size: 12px;
    opacity: 0.85;
    line-height: 1.4;
    margin-top: 4px;
  }
  .baCareBox__recommended{
    background: #4a4a4a;
    color: #fff;
    padding: 8px 20px;
    font-weight: 900;
    font-size: 13px;
    text-align: center;
    border-radius: 0 0 8px 8px;
  }
  .baCareBox__options{
    padding: 18px 20px 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }
  /* TCS custom selector UI - keeps underlying radio for accessibility */
  .ba-tcs-choice{
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .ba-tcs-option{
    display: flex;
    align-items: flex-start;
    gap: 12px;
    cursor: pointer;
    padding: 14px 16px;
    border-radius: 8px;
    border: 2px solid #e7e7e7;
    background: #fff;
    transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
  }
  .ba-tcs-option:hover{
    border-color: #ccc;
    background: #fafafa;
  }
  .ba-tcs-option:focus-within{
    outline: 2px solid var(--ba-accent);
    outline-offset: 2px;
  }
  .ba-tcs-option:has(input:checked){
    border-color: var(--ba-accent);
    background: rgba(209, 173, 84, 0.08);
    box-shadow: 0 0 0 1px var(--ba-accent);
  }
  .ba-tcs-option:has(input:checked):hover{
    border-color: var(--ba-accent);
    background: rgba(209, 173, 84, 0.1);
  }
  /* Visually hide radio, keep for accessibility (keyboard + screen readers) */
  .ba-tcs-option input[type="radio"]{
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
  .ba-tcs-indicator{
    width: 22px;
    height: 22px;
    min-width: 22px;
    border-radius: 50%;
    border: 2px solid #ccc;
    background: #fff;
    margin-top: 2px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.2s, background 0.2s;
  }
  .ba-tcs-option input[type="radio"]:checked ~ .ba-tcs-indicator{
    border-color: var(--ba-accent);
    background: var(--ba-accent);
  }
  .ba-tcs-option input[type="radio"]:checked ~ .ba-tcs-indicator::after{
    content: "✓";
    font-size: 12px;
    font-weight: 900;
    color: #1a1a1a;
    line-height: 1;
  }
  .ba-tcs-label{
    flex: 1;
    font-size: 14px;
    line-height: 1.5;
    color: #333;
  }
  .ba-tcs-label strong{
    font-weight: 900;
  }
  .ba-tcs-terms{
    display: block;
    font-size: 13px;
    margin-top: 6px;
    color: #555;
  }
  .ba-tcs-option .baCareRadio__link{
    color: #0066cc;
    text-decoration: underline;
    cursor: pointer;
  }
  .ba-tcs-option .baCareRadio__link:hover{
    color: #0052a3;
  }
  .ba-tcs-option:has(input[type="radio"]:disabled){
    cursor: not-allowed;
    opacity: 0.7;
  }
  .ba-tcs-option input[type="radio"]:disabled ~ .ba-tcs-label{
    cursor: not-allowed;
  }
  .ba-tcs-option input[type="radio"]:disabled ~ .ba-tcs-indicator{
    opacity: 0.6;
  }
  /* Legacy baCareRadio kept for compatibility, now uses tcs classes */
  .baCareRadio{
    display: flex;
    align-items: flex-start;
    gap: 10px;
    cursor: pointer;
  }

  /* Summary Box (Sticky) */
  .baExtrasRight{
    position: sticky;
    top: 14px;
    align-self: start;
  }
  @media (max-width: 980px){
    .baExtrasRight{ position: static; }
  }
  .baSummaryBox{
    background: #fff;
    border: 1px solid var(--ba-border);
    border-radius: 10px;
    padding: 18px;
    box-shadow: 0 10px 24px rgba(0,0,0,.05);
  }
  .baSummaryBox__flight{
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 14px;
  }
  .baSummaryBox__flightInfo{
    flex: 1;
  }
  .baSummaryBox__flightLabel{
    font-weight: 700;
    font-size: 14px;
    margin-bottom: 4px;
  }
  .baSummaryBox__flightRoute{
    font-weight: 800;
    font-size: 14px;
    line-height: 1.4;
    margin-bottom: 2px;
  }
  .baSummaryBox__flightDate{
    font-size: 13px;
    opacity: 0.75;
  }
  .baSummaryBox__divider{
    height: 1px;
    background: #e9e9e9;
    margin: 14px 0;
  }
  .baSummaryBox__items{
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .baSummaryBox__item{
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 4px 16px;
    align-items: start;
  }
  .baSummaryBox__itemLabel{
    font-weight: 700;
    font-size: 14px;
    grid-column: 1;
  }
  .baSummaryBox__itemValue{
    font-weight: 900;
    font-size: 16px;
    text-align: right;
    grid-column: 2;
    grid-row: 1;
  }
  .baSummaryBox__itemSub{
    font-size: 12px;
    opacity: 0.7;
    grid-column: 1;
    margin-top: 4px;
  }
  .baSummaryBox__itemSubValue{
    font-size: 12px;
    opacity: 0.7;
    text-align: right;
    grid-column: 2;
    margin-top: 4px;
  }
  .baSummaryBox__total{
    margin-top: 8px;
  }
  .baSummaryBox__totalLabel{
    font-weight: 900;
    font-size: 16px;
    margin-bottom: 8px;
  }
  .baSummaryBox__totalValue{
    font-weight: 1000;
    font-size: 28px;
    text-align: right;
    line-height: 1.1;
  }
  .baSummaryBox__totalWords{
    font-size: 11px;
    opacity: 0.65;
    margin-top: 6px;
    line-height: 1.4;
    text-align: right;
    font-style: italic;
  }

  /* Popup overlay */
  .baPopupOverlay{
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 99999;
  }
  .baPopupOverlay.active{
    display: flex;
  }
  .baPopup{
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .baPopup__header{
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  .baPopup__title{
    font-weight: 900;
    font-size: 20px;
  }
  .baPopup__close{
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: background 0.2s;
  }
  .baPopup__close:hover{
    background: #f0f0f0;
  }
</style>

<div class="baHeader">
  <div class="baHeaderTop">
    <div class="baHeaderNav">
      <a href="https://www.business-airfare.com/faqs">FAQs</a>
      <a href="https://www.business-airfare.com/about">About</a>
      <a href="https://www.business-airfare.com/privacy-policy">Privacy Policy</a>
      <a href="https://www.business-airfare.com/terms-and-conditions">Terms & Conditions</a>
    </div>
    <div class="baHeaderRight">
      ${(agentPhone || agentName) ? `
        <div class="baHeaderAgentRow">
          ${agentPhone ? `
            <div class="baHeaderPhone">
              <a href="tel:${escapeHtml(agentPhone.replace(/[^\d+]/g, ''))}">
                <svg class="baHeaderPhoneIcon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>${escapeHtml(fmtPhoneDisplay(agentPhone))}</span>
              </a>
            </div>
          ` : ""}
          ${agentPhone && agentName ? `<div class="baHeaderDivider"></div>` : ""}
          ${agentName && agentPhotoUrl ? `
            <div class="baHeaderAgent">
              <div class="baHeaderAgentContent">
                <div class="baHeaderAgentLabel">Travel agent</div>
                <div class="baHeaderAgentName">${escapeHtml(agentName)}</div>
              </div>
              <img src="${agentPhotoUrl}" alt="${escapeHtml(agentName)}" class="baHeaderAgentAvatar" onerror="this.style.display='none'">
            </div>
          ` : agentName ? `
            <div class="baHeaderAgent">
              <div class="baHeaderAgentContent">
                <div class="baHeaderAgentLabel">Travel agent</div>
                <div class="baHeaderAgentName">${escapeHtml(agentName)}</div>
              </div>
            </div>
          ` : ""}
        </div>
      ` : ""}
    </div>
  </div>
  <div class="baHeaderProgress">
    <div class="baHeaderProgressInner">
      <div class="baHeaderProgressLeft">
        <div class="baHeaderProgressTitle">Carefully check your flight and passenger details</div>
        <div class="baHeaderProgressSubtitle">${agentPhone ? `Have any questions? I am always available at ${escapeHtml(agentPhone)}` : 'Tickets at a good price are almost in your hands!'}</div>
      </div>
      <div class="baHeaderProgressSteps">
        <div class="baProgressStep">
          <div class="baProgressStepCircle completed">✓</div>
          <div class="baProgressStepLabel">Request a quote</div>
        </div>
        <div class="baProgressStepLine completed"></div>
        <div class="baProgressStep">
          <div class="baProgressStepCircle completed">✓</div>
          <div class="baProgressStepLabel">Review flight options</div>
        </div>
        <div class="baProgressStepLine completed"></div>
        <div class="baProgressStep">
          <div class="baProgressStepCircle active">3</div>
          <div class="baProgressStepLabel">Complete payment</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="baWrap">
  <div class="baPage">
    ${bannerHtml}

    <div class="baGrid">
      <section class="baFlightsPane">
        <div class="baSectionTitle">Flight Details</div>
        <div id="baFlightsFlow">
          ${journeys.map(journeyCardHtml).join("") || `<div class="baPanel">No itinerary found.</div>`}
        </div>
      </section>

      <aside class="baPaxPane">
        <div class="baSectionTitle">Passenger Details</div>

        <div class="baPaxWrap">
          ${Array.from({ length: paxCount }).map((_, i) => passengerBlockHtml(i)).join("")}

          <div class="baInfoBanner">
            <span class="baInfoIcon">i</span>
            <div>The quoted prices are not guaranteed until the tickets are issued</div>
          </div>
        </div>
      </aside>
    </div>

    <div class="baExtras" id="baExtras" style="display:none">
      <div class="baExtrasGrid">
        <div class="baExtrasLeft">
          
          <div class="baCareBox">
            <div class="baCareBox__header">
              <div class="baCareBox__headerLeft">
                <svg class="baCareBox__icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="baCareBox__titleWrap">
                  <div class="baCareBox__title">Travel Care Service</div>
                  <div class="baCareBox__subtitle">Add flexible cancellation, refund options, and priority support to your booking.</div>
                </div>
              </div>
            </div>
            <div class="baCareBox__content">
              <div class="baCareBox__benefits">
                <div class="baCareBox__benefit">
                  <span class="baCareBox__check">✓</span>
                  <div class="baCareBox__benefitText">
                    <div class="baCareBox__benefitTitle">Cancel Anytime — 80% Cash Refund</div>
                    <div class="baCareBox__benefitSub">Cancel for any reason and receive 80% of your ticket price back to your original payment method.</div>
                  </div>
                </div>
                <div class="baCareBox__benefit">
                  <span class="baCareBox__check">✓</span>
                  <div class="baCareBox__benefitText">
                    <div class="baCareBox__benefitTitle">Prefer Credit? Get 90% Back</div>
                    <div class="baCareBox__benefitSub">Choose a 90% refund as Business-Airfare credit for future travel. Validity and usage terms apply.</div>
                  </div>
                </div>
                <div class="baCareBox__benefit">
                  <span class="baCareBox__check">✓</span>
                  <div class="baCareBox__benefitText">
                    <div class="baCareBox__benefitTitle">First Airline Exchange Fee Covered</div>
                    <div class="baCareBox__benefitSub">We cover the airline's first exchange/change penalty once. Fare difference may apply.</div>
                  </div>
                </div>
                <div class="baCareBox__benefit">
                  <span class="baCareBox__check">✓</span>
                  <div class="baCareBox__benefitText">
                    <div class="baCareBox__benefitTitle">Mishandled Baggage Assistance</div>
                    <div class="baCareBox__benefitSub">Priority support to help track and escalate delayed/mishandled baggage according to airline policy.</div>
                  </div>
                </div>
                <div class="baCareBox__benefit">
                  <span class="baCareBox__check">✓</span>
                  <div class="baCareBox__benefitText">
                    <div class="baCareBox__benefitTitle">Didn't Use It? Get a Travel Voucher</div>
                    <div class="baCareBox__benefitSub">Receive a voucher equal to 50% of your TCS cost, up to $150, if no TCS benefits were used.</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="baCareBox__recommended">RECOMMENDED</div>
            <div class="baCareBox__options">
              <div class="ba-tcs-choice">
                <label class="ba-tcs-option baCareRadio">
                  <input type="radio" name="baCareOption" value="yes" id="baCareYes" ${careSelected ? "checked" : ""} ${selectionLocked || isExpired ? "disabled" : ""} aria-label="Yes, add Travel Care Service">
                  <span class="ba-tcs-indicator" aria-hidden="true"></span>
                  <span class="ba-tcs-label">
                    <strong>Yes</strong>, add Travel Care Service for <strong>${fmtMoney(careCents)}</strong>
                    <span class="ba-tcs-terms">I have read and agree to the <a href="${escapeHtml(termsUrl)}" target="_blank" rel="noopener noreferrer" class="baCareRadio__link" id="baTermsLink">Terms and Conditions</a></span>
                  </span>
                </label>
                <label class="ba-tcs-option baCareRadio">
                  <input type="radio" name="baCareOption" value="no" id="baCareNo" ${!careSelected ? "checked" : ""} ${selectionLocked || isExpired ? "disabled" : ""} aria-label="No, I choose not to protect">
                  <span class="ba-tcs-indicator" aria-hidden="true"></span>
                  <span class="ba-tcs-label">
                    <strong>No</strong>, I choose not to protect. Travel Care Service is not available after booking. <a href="#" class="baCareRadio__link" id="baReadMoreLink">Read more</a>
                  </span>
                </label>
              </div>
            </div>
          </div>

          <div class="baTipSection">
            <div class="baTipCard">
              <div class="baTipHeader">
                <div class="baTipTitle">Did I meet your expectations?</div>
                <div class="baTipSubtitle">If you feel that the service provided was exceptional, you can express your gratitude (optional).</div>
              </div>
              <div class="baTipControls">
                <div class="baTipRow">
                  ${tipPresets.map(p => `
                    <button class="baTipBtn ${String(p.label).toLowerCase() === "perfect" ? "baTipBtn--perfect" : ""} ${String(p.label).toLowerCase() === "exceptional" ? "baTipBtn--exceptional" : ""}"
                      data-mode="preset"
                      data-label="${escapeHtml(p.label)}"
                      data-amount="${Number(p.amount)||0}"
                      ${selectionLocked || isExpired ? "disabled" : ""}>
                      <div class="baTipBtnLabel">${escapeHtml(p.label)}</div>
                      <div class="baTipBtnAmount">$${((Number(p.amount)||0)/100).toFixed(2)}</div>
                    </button>
                  `).join("")}
                </div>
                <div id="baSelMsg" class="baTipHelper"></div>
              </div>
              <div class="baTipFooter">
                <div class="baTipFooterLeft">
                  <div class="baTipAgreeRow">
                    <input id="baTipAgree" class="baTipAgreeCheck" type="checkbox" ${selectionLocked || isExpired ? "disabled" : ""}>
                    <label class="baTipAgreeText" for="baTipAgree">I agree, that this amount will be charged in addition to the cost of the airline ticket(s)</label>
                  </div>
                </div>
                <div class="baTipFooterRight">
                  <div class="baTipBottomRow">
                    <button class="baTipCustomBtn" type="button" data-tip-step="-5" ${selectionLocked || isExpired ? "disabled" : ""}>−</button>
                    <div class="baTipCustomWrap">
                      <div class="baTipCustomField">
                      <input id="baTipCustom" class="baTipCustom" type="number" min="0" max="1000" step="0.01"
                          value="${tipMode === "custom" ? (tipAmount/100) : ""}"
                        placeholder="0.00"
                          ${selectionLocked || isExpired ? "disabled" : ""}>
                      </div>
                    </div>
                    <button class="baTipCustomBtn" type="button" data-tip-step="5" ${selectionLocked || isExpired ? "disabled" : ""}>+</button>
                    <button class="baTipBtn baTipBtn--compact" data-mode="none" ${selectionLocked || isExpired ? "disabled" : ""}>
                      <div class="baTipBtnLabel">No tip</div>
                    </button>
                  </div>
                </div>
                <div id="baTipAgreeMsg" class="baTipAgreeWarning"></div>
                <div id="baTipErrorMsg" style="display:none;color:#b00020;font-size:13px;margin-top:8px;"></div>
              </div>
            </div>
          </div>

          <div class="baExtrasStripe" style="margin-top:18px">
            <div id="baPayHint" style="margin-top:10px;font-size:13px;opacity:.75"></div>

            <div id="baStripeWrap" style="display:none;margin-top:16px;padding:16px;border:1px solid #eee;border-radius:12px;background:#fff">
              <div style="font-weight:900;margin-bottom:10px">Billing details</div>

              <div style="margin-bottom:12px">
                <div style="font-weight:900;font-size:13px;opacity:.8;margin-bottom:6px">Email</div>
                <div id="baLinkAuthMount"></div>
              </div>

              <div style="margin-bottom:14px">
                <div style="font-weight:900;font-size:13px;opacity:.8;margin-bottom:6px">Billing address</div>
                <div id="baAddressMount"></div>
              </div>

              <div style="font-weight:900;margin:16px 0 10px">Payment details</div>
              <div id="baStripeMount"></div>

              <button id="baStripeConfirm"
                style="margin-top:14px;width:100%;padding:12px 16px;border-radius:10px;border:1px solid #111;background:#111;color:#fff;font-weight:900;cursor:not-allowed;opacity:.6"
                disabled>
                Pay now
              </button>

              <div id="baStripeMsg" style="margin-top:10px;font-size:13px;opacity:.8">Please enter billing details to continue.</div>

              <div id="baTermsAgreeSection" class="baTermsAgreeSection">
                <label class="baTermsAgreeLabel">
                  <input id="baTermsAgreeCheck" class="baTermsAgreeCheck" type="checkbox" ${selectionLocked || isExpired ? "disabled" : ""}>
                  <span class="baTermsAgreeText">
                    <strong>By checking this box I affirm</strong> that I have read, understood and accepted present <a href="${escapeHtml(termsUrl)}" target="_blank" rel="noopener noreferrer" class="baTermsLink">Terms and Conditions</a>, <a href="#" class="baTermsLink">Privacy Policy</a> and <a href="https://www.business-airfare.com/convention" target="_blank" rel="noopener noreferrer" class="baTermsLink">airline liability limitations</a>, confirmed the accuracy of flight itinerary, and verified the spelling of the name(s) of the passenger(s) to be matching passenger(s) passport(s) / <a href="#" class="baTermsLink">valid travel document(s)</a>, as well as I have taken the consent of Credit Card Holder and all the passengers regarding the <a href="${escapeHtml(termsUrl)}" target="_blank" rel="noopener noreferrer" class="baTermsLink">Terms and Conditions</a> and <a href="#" class="baTermsLink">Privacy Policy</a>.
                  </span>
                </label>
                <div id="baTermsAgreeWarning" class="baTermsAgreeWarning">Please check this box if you accept the Rules and Restrictions</div>
              </div>
            </div>
          </div>
        </div>

        <div class="baExtrasRight">
          <div class="baSummaryBox">
            <div class="baSummaryBox__flight">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0">
                <path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
              </svg>
              <div class="baSummaryBox__flightInfo">
                <div class="baSummaryBox__flightLabel">Flight</div>
                ${journeys.length > 0 ? (() => {
                  const cp = cityPairFromJourney(journeys[0]);
                  const first = journeys[0]?.segments?.[0];
                  const departDay = first?.depart_local ? String(first.depart_local).slice(0,10) : "";
                  const dateLabel = departDay ? dateHeaderLabel(departDay) : "";
                  return `
                    <div class="baSummaryBox__flightRoute">${escapeHtml(cp.fromCity || cp.fromIata || "")} (${escapeHtml(cp.fromIata || "")}) → ${escapeHtml(cp.toCity || cp.toIata || "")} (${escapeHtml(cp.toIata || "")})</div>
                    <div class="baSummaryBox__flightDate">${escapeHtml(dateLabel)}</div>
                  `;
                })() : ""}
              </div>
            </div>

            <div class="baSummaryBox__divider"></div>

            <div class="baSummaryBox__items">
              <div class="baSummaryBox__item">
                <div class="baSummaryBox__itemLabel">One-Way Flight</div>
                <div class="baSummaryBox__itemValue">${fmtMoney(baseTicketService())}</div>
                <div class="baSummaryBox__itemSub">To be processed by airline</div>
                <div class="baSummaryBox__itemSubValue">${fmtMoney(ticketCents)}</div>
                <div class="baSummaryBox__itemSub">To be processed by Business-Airfare</div>
                <div class="baSummaryBox__itemSubValue">${fmtMoney(serviceCents)}</div>
              </div>
            </div>

            <div class="baSummaryBox__divider"></div>

            <div class="baSummaryBox__total">
              <div class="baSummaryBox__totalLabel">Total:</div>
              <div class="baSummaryBox__totalValue">${fmtMoney(payableTotalCents())}</div>
              <div class="baSummaryBox__totalWords">(${numberToWords(payableTotalCents())})</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="baSticky">
    <div class="baStickyIn">
      <div class="baStickyLeft">
        ${stickyLogo ? `
        <div class="baStickyLogo">
          <img src="${stickyLogo}" alt="" onerror="this.style.display='none'">
        </div>
        ` : ""}
        <div class="baStickyMessage">
          <span class="baStickyMessageText">You are almost there</span>
        </div>
      </div>

      <div class="baStickyRight">
        <div class="baStickyPrice">
          <div class="baStickyPriceTop">
            <div class="baStickyAmt" id="baStickyPerPax">${fmtMoney(perPaxCents)}</div>
            <div class="baStickyCur">${escapeHtml(data.currency || "USD")}</div>
          </div>
          <div class="baStickySub">Total price per passenger</div>
          <div class="baStickySmall"></div>
        </div>

        <button id="baPayBtn" class="baCTA" ${isExpired ? "disabled" : ""}>
          <span class="baCTATitle">BOOK</span>
          <span class="baCTARight" id="baStickyClock">${data.expires_at ? escapeHtml(expiresClock(data.expires_at)) : "—"}</span>
        </button>
      </div>
    </div>
  </div>
</div>
    `;

    wirePassengerAccordion(paxCount);

    // ✅ Wire passenger autosave AFTER HTML exists
    wirePassengerAutosave(data.public_id, paxCount);

    // ---------- countdown live update ----------
    let clockTimer = null;
    function updateButtonState(){
      if (!data.expires_at) return;
      const t = expiresClock(data.expires_at);
      const el1 = document.getElementById("baStickyClock");
      const payBtn = document.getElementById("baPayBtn");
      const btnTitle = payBtn ? payBtn.querySelector(".baCTATitle") : null;
      
      // Don't update button text if it's in "Preparing..." or "Processing..." state or if sticky bar is hidden (sections revealed)
      const stickyBar = root.querySelector(".baSticky");
      const isStickyBarHidden = stickyBar && stickyBar.style.display === "none";
      const currentBtnText = btnTitle ? (btnTitle.textContent || btnTitle.innerHTML || "") : "";
      const isPreparing = currentBtnText.includes("Preparing") || currentBtnText.includes("Preparing...");
      const isProcessing = currentBtnText.includes("Processing") || currentBtnText.includes("Processing...");
      const shouldSkipButtonUpdate = isPreparing || isProcessing || isStickyBarHidden;
      
      if (t === "00:00:00") {
        if (el1) el1.style.display = "none";
        if (btnTitle && !shouldSkipButtonUpdate) btnTitle.textContent = "CONTACT YOUR AGENT";
        if (payBtn) {
          payBtn.disabled = true;
          payBtn.style.opacity = ".55";
          payBtn.style.cursor = "not-allowed";
        }
      } else {
        if (el1) {
          el1.textContent = t;
          el1.style.display = "";
        }
        // Only update button text to "BOOK" if not in "Preparing..." state and sticky bar is still visible
        if (btnTitle && !shouldSkipButtonUpdate) btnTitle.textContent = "BOOK";
      }
    }
    function startClock(){
      if (!data.expires_at) return;
      updateButtonState(); // Check initial state
      if (clockTimer) clearInterval(clockTimer);
      clockTimer = setInterval(updateButtonState, 1000);
    }
    startClock();

    // ---------- selection UX ----------
    const selMsg = document.getElementById("baSelMsg");
    const hint = document.getElementById("baPayHint");
    const wrap = document.getElementById("baStripeWrap");
    const msg = document.getElementById("baStripeMsg");
    const confirmBtn = document.getElementById("baStripeConfirm");

    function setSelMsg(t){ if (selMsg) selMsg.textContent = t || ""; }

    let savingTimer = null;
    function setSaving(on){
      if (savingTimer) { clearTimeout(savingTimer); savingTimer = null; }
      if (on){
        savingTimer = setTimeout(() => setSelMsg(""), 250);
      } else {
        if (savingTimer) { clearTimeout(savingTimer); savingTimer = null; }
      }
    }

    function showTipError(message) {
      tipSaveError = message;
      const tipErrorMsg = document.getElementById("baTipErrorMsg");
      if (tipErrorMsg) {
        tipErrorMsg.textContent = message || "";
        tipErrorMsg.style.display = message ? "block" : "none";
      }
      setConfirmEnabled(validateBillingUI());
    }

    function clearTipError() {
      tipSaveError = null;
      const tipErrorMsg = document.getElementById("baTipErrorMsg");
      if (tipErrorMsg) {
        tipErrorMsg.textContent = "";
        tipErrorMsg.style.display = "none";
      }
    }

    async function updateTipAgreementUI(){
      const tipAgree = document.getElementById("baTipAgree");
      const tipAgreeRow = document.querySelector(".baTipAgreeRow");
      const tipAgreeMsg = document.getElementById("baTipAgreeMsg");
      const shouldWarn = selectedTipAmount() > 0 && !tipAgreed;
      if (tipAgree) tipAgree.checked = !!tipAgreed;
      if (tipAgreeRow) tipAgreeRow.classList.toggle("is-warn", shouldWarn);
      if (tipAgreeMsg) {
        tipAgreeMsg.textContent = shouldWarn
          ? "Please check this box if you agree that this amount will be charged in addition to the cost of the airline ticket(s), or choose the \"no tip\" box."
          : "";
        tipAgreeMsg.style.display = shouldWarn ? "block" : "none";
      }
      
      // If tip is unchecked or tip is selected but checkbox unchecked, reset acceptance
      if (shouldWarn) {
        acceptanceCompleted = false;
      } else {
        // Check if both checkboxes are checked, then call record_acceptance
        const termsCheckbox = document.getElementById("baTermsAgreeCheck");
        const termsChecked = termsCheckbox && termsCheckbox.checked;
        
        if (termsChecked && !acceptanceInProgress && !acceptanceCompleted) {
          acceptanceInProgress = true;
          try {
            console.log("[BOOK_FLOW] Recording acceptance from tip checkbox", {
              termsChecked: true,
              tipChecked: true
            });
            // Always pass true for tip_ack - it means "I acknowledge tips/extra charges"
            await recordAcceptance(publicId, true, true);
            acceptanceCompleted = true;
            console.log("[BOOK_FLOW] Acceptance recorded successfully");
            
            // Immediately update button state after successful acceptance
            setConfirmEnabled(validateBillingUI());
          } catch (e) {
            console.error("[BOOK_FLOW] Failed to record acceptance:", e);
            // Don't uncheck the checkbox on error - just mark acceptance as incomplete
            // The user can try again or the error will be handled when they click Pay
            acceptanceCompleted = false;
            // Show error message if msg element exists
            const msg = document.getElementById("baStripeMsg");
            if (msg) {
              msg.textContent = "Could not record acceptance. Please try again or contact support.";
              msg.style.color = "#b00020";
            }
            // Update button state even on error
            setConfirmEnabled(validateBillingUI());
          } finally {
            acceptanceInProgress = false;
          }
        } else if (!termsChecked) {
          // If terms checkbox is not checked, reset acceptance
          // (but don't uncheck the tip checkbox - user might check terms checkbox next)
          acceptanceCompleted = false;
          setConfirmEnabled(validateBillingUI());
        }
      }
      
      // Always update Pay Now button state when tip agreement changes
      setConfirmEnabled(validateBillingUI());
    }

    function buildTipPayload(){
      // Save tip selection based on tipMode and tipAmount, regardless of tipAgreed checkbox
      // The tipAgreed checkbox is for UI validation/payment flow, not for what gets saved to DB
      if (tipMode === "none" || selectedTipAmount() <= 0) {
        return { mode: "none", preset_label: null, amount: 0 };
      }
      const preset = tipMode === "preset" ? resolvedPreset() : null;
      const amount = Number.isFinite(selectedTipAmount()) ? selectedTipAmount() : 0;
      return {
        mode: tipMode || "none",
        preset_label: (tipMode === "preset" ? ((preset && preset.label) || tipPresetLabel || null) : null),
        amount: amount
      };
    }

    function updateTotalsUI(){
      const pay = payableTotalCents();
      const payEl = document.getElementById("baPayableTotal");
      if (payEl) payEl.textContent = `${fmtMoney(pay)} ${escapeHtml(data.currency || "USD")}`;
      updateSummaryBox();
      updateTipAgreementUI();
      // sticky per pax stays as-is
    }

    updateTotalsUI();
    applyTipHighlights();

    function updateSummaryBox(){
      const summaryBox = root.querySelector(".baSummaryBox");
      if (!summaryBox) return;

      // Update Travel Care Service line
      let careItem = summaryBox.querySelector(".baSummaryBox__item[data-item='care']");
      if (careSelected) {
        if (!careItem) {
          const items = summaryBox.querySelector(".baSummaryBox__items");
          if (items) {
            const div = document.createElement("div");
            div.className = "baSummaryBox__item";
            div.setAttribute("data-item", "care");
            div.innerHTML = `
              <div class="baSummaryBox__itemLabel">Travel Care Service</div>
              <div class="baSummaryBox__itemValue">${fmtMoney(careCents)}</div>
              <div class="baSummaryBox__itemSub" style="grid-column: 1 / -1;">Non-refundable charge by Business-Airfare</div>
            `;
            items.appendChild(div);
            careItem = div;
          }
        } else {
          const label = careItem.querySelector(".baSummaryBox__itemLabel");
          const value = careItem.querySelector(".baSummaryBox__itemValue");
          if (label) label.textContent = "Travel Care Service";
          if (value) value.textContent = fmtMoney(careCents);
        }
      } else {
        if (careItem) careItem.remove();
      }

      // Update Tip line
      let tipItem = summaryBox.querySelector(".baSummaryBox__item[data-item='tip']");
      const effectiveTip = appliedTipAmount();
      if (effectiveTip > 0) {
        if (!tipItem) {
          const items = summaryBox.querySelector(".baSummaryBox__items");
          if (items) {
            const div = document.createElement("div");
            div.className = "baSummaryBox__item";
            div.setAttribute("data-item", "tip");
            div.innerHTML = `
              <div class="baSummaryBox__itemLabel">Token of Appreciation</div>
              <div class="baSummaryBox__itemValue">${fmtMoney(effectiveTip)}</div>
              <div class="baSummaryBox__itemSub" style="grid-column: 1 / -1;">Non-refundable charge by Business-Airfare</div>
            `;
            items.appendChild(div);
            tipItem = div;
          }
        } else {
          const label = tipItem.querySelector(".baSummaryBox__itemLabel");
          const value = tipItem.querySelector(".baSummaryBox__itemValue");
          if (label) label.textContent = "Token of Appreciation";
          if (value) value.textContent = fmtMoney(effectiveTip);
        }
      } else {
        if (tipItem) tipItem.remove();
      }

      // Update grand total
      const totalValue = summaryBox.querySelector(".baSummaryBox__totalValue");
      const totalWords = summaryBox.querySelector(".baSummaryBox__totalWords");
      const total = payableTotalCents();
      if (totalValue) totalValue.textContent = fmtMoney(total);
      if (totalWords) totalWords.textContent = `(${numberToWords(total)})`;
    }

    // Travel Care Service radio buttons - custom UI (ba-tcs-option) wraps visually hidden inputs
    // careYes/careNo are the underlying radios; handleCareSelection drives update_selection
    const careYes = document.getElementById("baCareYes");
    const careNo = document.getElementById("baCareNo");
    
    // Disable only payment buttons while totals are being updated
    // This prevents proceeding with stale totals while keeping TCS/tip inputs interactive
    function setPaymentButtonsDisabled(disabled) {
      const continueBtn = document.getElementById("baContinueToPayment");
      const confirmBtn = document.getElementById("baStripeConfirm");
      
      if (continueBtn) {
        continueBtn.disabled = disabled;
        continueBtn.style.opacity = disabled ? ".6" : "1";
        continueBtn.style.cursor = disabled ? "not-allowed" : "pointer";
      }
      if (confirmBtn) {
        confirmBtn.disabled = disabled;
        confirmBtn.style.opacity = disabled ? ".6" : "1";
        confirmBtn.style.cursor = disabled ? "not-allowed" : "pointer";
      }
    }
    
    function handleCareSelection(newSelected) {
      if (selectionLocked || isExpired) return;
      
      const wasSelected = careSelected;
      
      // OPTIMISTIC UPDATE: Update UI immediately
      careSelected = newSelected;
      if (careYes) careYes.checked = newSelected;
      if (careNo) careNo.checked = !newSelected;
      updateSummaryBox();
      updateTotalsUI();
      
      // Disable payment buttons to prevent proceeding with stale totals
      setPaymentButtonsDisabled(true);
      setSaving(true);
      setSelMsg("");

      const tip = buildTipPayload();

      updateSelection(data.public_id, { care_selected: careSelected, tip })
        .then(async (result) => {
          setSaving(false);
          setSelMsg("");
          setPaymentButtonsDisabled(false);
          
          // If a new client_secret was returned (PaymentIntent was updated/recreated), update Stripe Elements
          if (result.client_secret && paymentElement) {
            try {
              // Use preserveState=true to avoid full remount if possible
              await mountStripePaymentElement(result.client_secret, true);
              // Don't show message - it's disruptive
            } catch (e) {
              console.error("Failed to update Stripe Elements:", e);
              // Don't fail the update - selection was saved successfully
            }
          }
        })
        .catch((e) => {
          // REVERT on error
          careSelected = wasSelected;
          if (careYes) careYes.checked = wasSelected;
          if (careNo) careNo.checked = !wasSelected;
          updateSummaryBox();
          updateTotalsUI();
          setSaving(false);
          setPaymentButtonsDisabled(false);
          setSelMsg("Could not update: " + (e && e.message ? e.message : String(e)));
        });
    }

    if (careYes) {
      careYes.addEventListener("change", () => {
        if (careYes.checked) handleCareSelection(true);
      });
    }
    if (careNo) {
      careNo.addEventListener("change", () => {
        if (careNo.checked) handleCareSelection(false);
      });
    }

    // Tip buttons
    const tipBtns = Array.from(document.querySelectorAll(".baTipBtn"));
    tipBtns.forEach(btn => {
      btn.addEventListener("click", async () => {
        try {
          const mode = btn.getAttribute("data-mode");
          const prev = { tipMode, tipPresetLabel, tipAmount, tipAgreed };

          if (mode === "none") {
            // OPTIMISTIC UPDATE
            tipMode = "none";
            tipPresetLabel = "";
            tipAmount = 0;
            tipAgreed = false;
            const tipCustom = document.getElementById("baTipCustom");
            if (tipCustom) tipCustom.value = "";
            applyTipHighlights();
            updateTotalsUI();
            
            if (!tipAgreed && tipAmount > 0) {
              setSelMsg("");
              return;
            }

            setPaymentButtonsDisabled(true);
            setSaving(true);
            setSelMsg("");

            try {
              const tip = { mode: "none", preset_label: null, amount: 0 };
              const result = await updateSelection(data.public_id, { care_selected: !!careSelected, tip });
              updateTotalsUI();
              setSaving(false);
              setPaymentButtonsDisabled(false);
              setSelMsg("");
              
              // If a new client_secret was returned, update Stripe Elements gracefully
              if (result.client_secret && paymentElement) {
                try {
                  await mountStripePaymentElement(result.client_secret, true);
                } catch (remountErr) {
                  console.error("Failed to update Stripe Elements:", remountErr);
                }
              }
            } catch (e) {
              // REVERT on error
              tipMode = prev.tipMode; tipPresetLabel = prev.tipPresetLabel; tipAmount = prev.tipAmount; tipAgreed = prev.tipAgreed;
              applyTipHighlights(); updateTotalsUI();
              setSaving(false);
              setPaymentButtonsDisabled(false);
              setSelMsg("Could not update: " + (e && e.message ? e.message : String(e)));
            }
            return;
          }

          if (mode === "preset") {
            const label = btn.getAttribute("data-label");
            const preset = tipPresets.find(p => String(p.label) === String(label || ""));
            const amount = Math.round(Number(preset ? preset.amount : btn.getAttribute("data-amount")) || 0);

            // OPTIMISTIC UPDATE
            tipMode = "preset";
            tipPresetLabel = label || "";
            tipAmount = amount;
            tipAgreed = false;

            const tipCustom = document.getElementById("baTipCustom");
            if (tipCustom) tipCustom.value = amount > 0 ? (amount / 100).toFixed(2) : "";
            applyTipHighlights();
            updateTotalsUI();
            
            setPaymentButtonsDisabled(true);
            setSaving(true);
            setSelMsg("");

            try {
              const tip = buildTipPayload();
              console.log("[TIP_SELECTION] Saving tip preset selection:", tip);
              const result = await updateSelection(data.public_id, { care_selected: !!careSelected, tip });
              console.log("[TIP_SELECTION] Tip preset saved successfully:", result);
              clearTipError();
              updateTotalsUI();
              setSaving(false);
              setPaymentButtonsDisabled(false);
              setSelMsg("");
              
              // If a new client_secret was returned, update Stripe Elements gracefully
              if (result.client_secret && paymentElement) {
                try {
                  await mountStripePaymentElement(result.client_secret, true);
                } catch (remountErr) {
                  console.error("Failed to update Stripe Elements:", remountErr);
                }
              }
            } catch (e) {
              // REVERT on error
              tipMode = prev.tipMode; tipPresetLabel = prev.tipPresetLabel; tipAmount = prev.tipAmount; tipAgreed = prev.tipAgreed;
              applyTipHighlights(); updateTotalsUI();
              setSaving(false);
              setPaymentButtonsDisabled(false);
              const errorMsg = "Could not save tip selection. Please try again.";
              setSelMsg(errorMsg);
              showTipError(errorMsg);
              console.error("[TIP_SELECTION] Failed to save tip preset:", e);
            }
            return;
          }
        } catch (e) {
          setSelMsg("Could not update: " + (e && e.message ? e.message : String(e)));
          setPaymentButtonsDisabled(false);
        }
      });
    });

    // Custom tip
    const tipCustom = document.getElementById("baTipCustom");
    if (tipCustom) {
      tipCustom.addEventListener("blur", async () => {
        try {
          const dollars = tipCustom.value === "" ? 0 : Number(tipCustom.value);
          const cents = clampInt(dollars * 100, tipMin, tipMax);
          tipCustom.value = cents > 0 ? (cents / 100).toFixed(2) : "";

          const prev = { tipMode, tipPresetLabel, tipAmount, tipAgreed };
          
          // OPTIMISTIC UPDATE
          tipMode = (cents <= 0 ? "none" : "custom");
          tipPresetLabel = "";
          tipAmount = (cents <= 0 ? 0 : cents);
          tipAgreed = false;

          applyTipHighlights();
          updateTotalsUI();
          
          if (!tipAgreed && tipAmount > 0) {
            setSelMsg("");
            return;
          }

          setPaymentButtonsDisabled(true);
          setSaving(true);
          setSelMsg("");

          const tip = buildTipPayload();
          console.log("[TIP_SELECTION] Saving custom tip selection:", tip);

          try {
            const result = await updateSelection(data.public_id, { care_selected: !!careSelected, tip });
            console.log("[TIP_SELECTION] Custom tip saved successfully:", result);
            clearTipError();

            applyTipHighlights();
            updateTotalsUI();

            setSaving(false);
            setPaymentButtonsDisabled(false);
            setSelMsg("");
            
            // If a new client_secret was returned, update Stripe Elements gracefully
            if (result.client_secret && paymentElement) {
              try {
                await mountStripePaymentElement(result.client_secret, true);
              } catch (remountErr) {
                console.error("Failed to update Stripe Elements:", remountErr);
              }
            }
          } catch (e) {
            // REVERT on error
            tipMode = prev.tipMode; tipPresetLabel = prev.tipPresetLabel; tipAmount = prev.tipAmount; tipAgreed = prev.tipAgreed;
            applyTipHighlights(); updateTotalsUI();
            setSaving(false);
            setPaymentButtonsDisabled(false);
            const errorMsg = "Could not save tip selection. Please try again.";
            setSelMsg(errorMsg);
            showTipError(errorMsg);
            console.error("[TIP_SELECTION] Failed to save custom tip:", e);
          }
          
          // If a new client_secret was returned, update Stripe Elements gracefully
          if (result.client_secret && paymentElement) {
            try {
              await mountStripePaymentElement(result.client_secret, true);
            } catch (remountErr) {
              console.error("Failed to update Stripe Elements:", remountErr);
            }
          }
        } catch (e) {
          // REVERT on error
          tipMode = prev.tipMode;
          tipPresetLabel = prev.tipPresetLabel;
          tipAmount = prev.tipAmount;
          tipAgreed = prev.tipAgreed;
          applyTipHighlights();
          updateTotalsUI();
          setSaving(false);
          setPaymentButtonsDisabled(false);
          setSelMsg("Could not update: " + (e && e.message ? e.message : String(e)));
        }
      });
    }

    const tipStepButtons = Array.from(document.querySelectorAll(".baTipCustomBtn"));
    if (tipCustom && tipStepButtons.length) {
      tipStepButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          if (tipCustom.disabled) return;
          const step = Number(btn.getAttribute("data-tip-step") || 0);
          const current = tipCustom.value === "" ? 0 : Number(tipCustom.value);
          const next = Math.max(0, Math.min(1000, current + step));
          tipCustom.value = String(next);
          tipCustom.dispatchEvent(new Event("blur"));
        });
      });
    }

    const tipAgree = document.getElementById("baTipAgree");
    if (tipAgree) {
      tipAgree.addEventListener("change", async () => {
        if (selectionLocked || isExpired) return;
        tipAgreed = !!tipAgree.checked;
        updateTotalsUI();
        updateTipAgreementUI(); // This now also updates Pay Now button state
        setPaymentButtonsDisabled(true);
        setSaving(true);
        setSelMsg("");
        try {
          const tip = buildTipPayload();
          console.log("[TIP_SELECTION] Saving tip checkbox confirmation:", tip);
          const result = await updateSelection(data.public_id, { care_selected: !!careSelected, tip });
          console.log("[TIP_SELECTION] Tip checkbox save successful:", result);
          clearTipError();
          updateTotalsUI();
          updateTipAgreementUI(); // Update button state after save
          setSaving(false);
          setPaymentButtonsDisabled(false);
          setSelMsg("");
          if (result.client_secret && paymentElement) {
            try {
              await mountStripePaymentElement(result.client_secret, true);
            } catch (remountErr) {
              console.error("Failed to update Stripe Elements:", remountErr);
            }
          }
        } catch (e) {
          updateTotalsUI();
          updateTipAgreementUI(); // Update button state on error
          setSaving(false);
          setPaymentButtonsDisabled(false);
          const errorMsg = "Could not save tip selection. Please try again.";
          setSelMsg(errorMsg);
          showTipError(errorMsg);
          console.error("[TIP_SELECTION] Failed to save tip checkbox:", e);
        }
      });
    }

    // Terms agreement checkbox handler
    async function updateTermsAgreementUI() {
      const termsCheckbox = document.getElementById("baTermsAgreeCheck");
      const termsSection = document.getElementById("baTermsAgreeSection");
      const termsWarning = document.getElementById("baTermsAgreeWarning");
      
      if (!termsCheckbox || !termsSection) return;
      
      const isChecked = termsCheckbox.checked;
      const shouldWarn = !isChecked;
      
      // Update section styling
      if (shouldWarn) {
        termsSection.classList.add("is-warn");
        acceptanceCompleted = false;
      } else {
        termsSection.classList.remove("is-warn");
        
        // Check if both checkboxes are checked, then call record_acceptance
        const tipAgreeCheckbox = document.getElementById("baTipAgree");
        const tipBtns = document.querySelectorAll(".baTipBtn.is-active[data-mode='preset'], .baTipBtn.is-active[data-mode='custom']");
        const hasTipSelected = tipBtns.length > 0;
        const tipChecked = !hasTipSelected || (tipAgreeCheckbox && tipAgreeCheckbox.checked);
        
        // Both checkboxes must be checked to record acceptance
        // tip_ack should always be true when recording (it means "I acknowledge tips/extra charges")
        if (tipChecked && !acceptanceInProgress && !acceptanceCompleted) {
          acceptanceInProgress = true;
          try {
            console.log("[BOOK_FLOW] Recording acceptance from terms checkbox", {
              termsChecked: true,
              tipChecked,
              hasTipSelected
            });
            // Always pass true for tip_ack - it means "I acknowledge tips/extra charges" regardless of whether tip is selected
            await recordAcceptance(publicId, true, true);
            acceptanceCompleted = true;
            console.log("[BOOK_FLOW] Acceptance recorded successfully");
            
            // Immediately update button state after successful acceptance
            setConfirmEnabled(validateBillingUI());
          } catch (e) {
            console.error("[BOOK_FLOW] Failed to record acceptance:", e);
            // Don't uncheck the checkbox on error - just mark acceptance as incomplete
            // The user can try again or the error will be handled when they click Pay
            acceptanceCompleted = false;
            // Show error message if msg element exists
            const msg = document.getElementById("baStripeMsg");
            if (msg) {
              msg.textContent = "Could not record acceptance. Please try again or contact support.";
              msg.style.color = "#b00020";
            }
            // Update button state even on error
            setConfirmEnabled(validateBillingUI());
          } finally {
            acceptanceInProgress = false;
          }
        } else if (!tipChecked && hasTipSelected) {
          // If tip checkbox is not checked but tip is selected, reset acceptance
          // (but don't uncheck the terms checkbox - user might check tip checkbox next)
          acceptanceCompleted = false;
          setConfirmEnabled(validateBillingUI());
        }
      }
      
      // Always update button state
      setConfirmEnabled(validateBillingUI());
    }

    const termsCheckbox = document.getElementById("baTermsAgreeCheck");
    if (termsCheckbox) {
      termsCheckbox.addEventListener("change", async () => {
        await updateTermsAgreementUI();
      });
    }

    // Wire up terms links (if they exist in the new section)
    // Update links to use terms_url from server if available
    const termsLinks = document.querySelectorAll(".baTermsLink");
    termsLinks.forEach(link => {
      const linkText = link.textContent.trim();
      if (linkText.includes("Terms and Conditions")) {
        // Set href to terms_url from server
        link.setAttribute("href", termsUrl);
        link.setAttribute("target", "_blank");
        link.setAttribute("rel", "noopener noreferrer");
      }
      link.addEventListener("click", (e) => {
        e.preventDefault();
        if (linkText.includes("Terms and Conditions")) {
          // Open in new tab
          window.open(termsUrl, "_blank", "noopener,noreferrer");
        } else if (linkText.includes("Privacy Policy")) {
          createPopup("Privacy Policy", "<p>Privacy Policy content will be displayed here.</p>");
        } else if (linkText.includes("airline liability limitations")) {
          // Open convention page in new tab
          window.open("https://www.business-airfare.com/convention", "_blank", "noopener,noreferrer");
        } else if (linkText.includes("valid travel document")) {
          createPopup("Valid Travel Documents", "<p>Information about valid travel documents will be displayed here.</p>");
        }
      });
    });

    // Initialize terms UI state
    updateTermsAgreementUI();

    // Popup functionality for Terms & Conditions and Read More
    function createPopup(title, content) {
      const overlay = document.createElement("div");
      overlay.className = "baPopupOverlay";
      overlay.innerHTML = `
        <div class="baPopup">
          <div class="baPopup__header">
            <div class="baPopup__title">${escapeHtml(title)}</div>
            <button class="baPopup__close" aria-label="Close">&times;</button>
          </div>
          <div class="baPopup__content">
            ${typeof content === "string" ? content : "<p>Content coming soon.</p>"}
          </div>
        </div>
      `;

      const closeBtn = overlay.querySelector(".baPopup__close");
      const closePopup = () => {
        overlay.classList.remove("active");
        setTimeout(() => overlay.remove(), 300);
      };

      closeBtn.addEventListener("click", closePopup);
      overlay.addEventListener("click", (e) => {
        if (e.target === overlay) closePopup();
      });

      document.body.appendChild(overlay);
      requestAnimationFrame(() => overlay.classList.add("active"));
    }

    const termsLink = document.getElementById("baTermsLink");
    const readMoreLink = document.getElementById("baReadMoreLink");

    if (termsLink) {
      // Update href to terms_url from server
      termsLink.setAttribute("href", termsUrl);
      termsLink.setAttribute("target", "_blank");
      termsLink.setAttribute("rel", "noopener noreferrer");
      termsLink.addEventListener("click", (e) => {
        e.preventDefault();
        window.open(termsUrl, "_blank", "noopener,noreferrer");
      });
    }

    if (readMoreLink) {
      readMoreLink.addEventListener("click", (e) => {
        e.preventDefault();
        createPopup("Read More", "<p>Additional information about Travel Care Service will be displayed here.</p>");
      });
    }

    function disablePrimary(reason){
      const payBtn = document.getElementById("baPayBtn");
      if (payBtn) {
        payBtn.disabled = true;
        payBtn.style.opacity = ".55";
        payBtn.style.cursor = "not-allowed";
      }
      if (hint) hint.textContent = reason || "";
    }

    if (isExpired || (data.ui && data.ui.payment_enabled === false)) {
      const reason = isExpired ? "Payment disabled: expired" : ("Payment disabled: " + (data.ui.reason_disabled || "disabled"));
      disablePrimary(reason);
      return;
    }

    // Pay button -> reveal Optional Services (step 1), then start_payment (step 2)
    let optionalServicesRevealed = false;
    const payBtn = document.getElementById("baPayBtn");
    const stickyBar = root.querySelector(".baSticky");
    const extrasSection = document.getElementById("baExtras");

    // Function to reveal payment UI sections (TCS, tips, Stripe area)
    // Attempts to initialize Stripe Elements, but handles acceptance_required gracefully
    async function revealPaymentUI() {
      console.log("[BOOK_FLOW] revealPaymentUI called - revealing UI and attempting to initialize Stripe Elements");
      
      if (extrasSection) {
        // Keep sections hidden initially - they will be shown after Stripe elements are loaded
        // extrasSection.style.display = "block"; // Moved to after Stripe is ready
        
        // Preselect "Excellent" tip and uncheck "I agree" checkbox
        const excellentPreset = tipPresets.find(p => String(p.label).toLowerCase() === "excellent");
        if (excellentPreset) {
          const excellentAmount = Math.round(Number(excellentPreset.amount) || 0);
          tipMode = "preset";
          tipPresetLabel = excellentPreset.label;
          tipAmount = excellentAmount;
          tipAgreed = false;
          
          // Update custom tip input to show the amount
          const tipCustom = document.getElementById("baTipCustom");
          if (tipCustom) {
            tipCustom.value = excellentAmount > 0 ? (excellentAmount / 100).toFixed(2) : "";
          }
          
          // Uncheck "I agree" checkbox
          const tipAgree = document.getElementById("baTipAgree");
          if (tipAgree) {
            tipAgree.checked = false;
          }
          
          // Update UI highlights and totals
          applyTipHighlights();
          updateTipAgreementUI();
          updateTotalsUI();
        }
        
        // Keep Stripe wrap hidden initially - it will be shown after Stripe elements are loaded
        // if (wrap) wrap.style.display = "block"; // Moved to after Stripe is ready
        
        // Initialize Stripe Elements immediately when Book is clicked
        // This allows users to see and fill in the payment form
        try {
          console.log("[BOOK_FLOW] Calling start_payment to initialize Stripe Elements");
          const res = await fetch(START_PAYMENT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ public_id: publicId })
          });
          
          const payload = await res.json().catch(() => ({}));
          
          if (res.ok && payload.client_secret) {
            // Success - initialize Stripe Elements
            console.log("[BOOK_FLOW] start_payment succeeded, initializing Stripe Elements");
            await mountStripePaymentElement(payload.client_secret, false);
            await waitForStripeReady(8000);
            
            // NOW that Stripe elements are fully loaded, reveal sections and hide sticky bar
            if (extrasSection) {
              extrasSection.style.display = "block";
            }
            if (wrap) {
              wrap.style.display = "block";
            }
            
            // Hide sticky bar
            if (stickyBar) stickyBar.style.display = "none";
            
            // Scroll to Optional Services section
            try { extrasSection.scrollIntoView({ behavior: "smooth", block: "start" }); } catch(_) {}
            
            if (msg) msg.textContent = "";
            console.log("[BOOK_FLOW] Stripe Elements initialized successfully - sections revealed");
          } else {
            // Error - show message
            const errorMsg = payload?.error || `HTTP ${res.status}`;
            console.error("[BOOK_FLOW] start_payment failed:", errorMsg);
            if (msg) {
              msg.textContent = "Could not load payment form. Please refresh the page.";
              msg.style.color = "#b00020";
            }
            // Restore button text on error
            const payBtn = document.getElementById("baPayBtn");
            const btnTitle = payBtn ? payBtn.querySelector(".baCTATitle") : null;
            if (btnTitle) {
              btnTitle.textContent = "BOOK";
            }
          }
        } catch (e) {
          // Network or other error
          console.error("[BOOK_FLOW] start_payment error:", e.message);
          if (msg) {
            msg.textContent = "Could not load payment form. Please refresh the page.";
            msg.style.color = "#b00020";
          }
          // Restore button text on error
          const payBtn = document.getElementById("baPayBtn");
          const btnTitle = payBtn ? payBtn.querySelector(".baCTATitle") : null;
          if (btnTitle) {
            btnTitle.textContent = "BOOK";
          }
        }
        
        // Initialize terms checkbox UI state
        updateTermsAgreementUI();
      }
    }


    // Function to initialize payment (called only when Pay button is clicked)
    // This function calls start_payment and initializes Stripe Elements
    async function initializePayment() {
      console.log("[BOOK_FLOW] initializePayment called - will call start_payment and initialize Stripe");
      
      // Guard: If Stripe Elements are already mounted and ready, return
      if (paymentElement && elements) {
        const payMount = document.getElementById("baStripeMount");
        if (payMount && payMount.querySelector("iframe")) {
          console.log("[BOOK_FLOW] Stripe Elements already initialized");
          return Promise.resolve();
        }
      }

      try {
        // require passenger validity
        const paxOk = validateAllPassengers(paxCount);
        if (!paxOk){
          showPaxToast("Please fix highlighted passenger fields first.", false);
          const firstBad = root.querySelector(".baBoxInput.is-invalid, .baPaxGender.is-invalid");
          if (firstBad && firstBad.scrollIntoView){
            try { firstBad.scrollIntoView({ behavior:"smooth", block:"center" }); } catch(_) {}
          }
          return Promise.reject(new Error("Passenger validation failed"));
        }

        // Record acceptance before calling start_payment
        const termsCheckbox = document.getElementById("baTermsAgreeCheck");
        const tipAgreeCheckbox = document.getElementById("baTipAgree");
        const tipBtns = document.querySelectorAll(".baTipBtn.is-active[data-mode='preset'], .baTipBtn.is-active[data-mode='custom']");
        const hasTipSelected = tipBtns.length > 0;
        const termsChecked = termsCheckbox && termsCheckbox.checked;
        const tipChecked = !hasTipSelected || (tipAgreeCheckbox && tipAgreeCheckbox.checked);

        if (!termsChecked || !tipChecked) {
          throw new Error("Please check both the Terms & Conditions and Tip agreement boxes before proceeding.");
        }

        // Record acceptance
        console.log("[BOOK_FLOW] Recording acceptance before start_payment");
        try {
          const acceptRes = await fetch(RECORD_ACCEPTANCE, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              public_id: publicId, 
              tip_ack: true, 
              terms_accepted: true 
            })
          });
          const acceptPayload = await acceptRes.json().catch(() => ({}));
          console.log("[BOOK_FLOW] record_acceptance response", {
            status: acceptRes.status,
            ok: acceptRes.ok,
            payload: acceptPayload
          });
          if (!acceptRes.ok) {
            throw new Error(`Failed to record acceptance: ${acceptPayload?.error || acceptRes.status}`);
          }
          acceptanceCompleted = true;
        } catch (acceptErr) {
          console.error("[BOOK_FLOW] record_acceptance error", acceptErr);
          throw new Error(`Acceptance required: ${acceptErr.message}`);
        }

        // Call start_payment
        console.log("[BOOK_FLOW] Calling start_payment", { public_id: publicId });
        const res = await fetch(START_PAYMENT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ public_id: publicId })
        });

        const payload = await res.json().catch(() => ({}));
        console.log("[BOOK_FLOW] start_payment response", {
          status: res.status,
          ok: res.ok,
          payload: payload
        });
        
        if (!res.ok) {
          const m = payload && payload.error ? payload.error : ("HTTP " + res.status);
          throw new Error(m);
        }

        if (!payload.client_secret) throw new Error("No client_secret returned from start_payment.");

        // Mount Stripe Elements (only if not already mounted)
        // Use preserveState=true to avoid clearing user input if elements already exist
        console.log("[BOOK_FLOW] Mounting Stripe Elements");
        const shouldPreserve = !!(paymentElement && elements);
        await mountStripePaymentElement(payload.client_secret, shouldPreserve);

        // Wait for Stripe Elements iframes to appear
        await waitForStripeReady(8000);
        console.log("[BOOK_FLOW] Stripe Elements ready");

        if (msg) msg.textContent = "";

        return Promise.resolve();

      } catch (e) {
        console.error("[BOOK_FLOW] initializePayment error", e);
        throw e;
      }
    }


    // Main handler for Book button click - reveals UI and attempts to initialize Stripe Elements
    async function handleBookClick() {
      console.log("[BOOK_FLOW] Book button clicked - revealing UI and attempting to initialize Stripe Elements");
      
      try {
        // If Optional Services not revealed, reveal them now
        if (!optionalServicesRevealed) {
          // require passenger validity before letting them proceed
          const paxOk = validateAllPassengers(paxCount);
          if (!paxOk){
            showPaxToast("Please fix highlighted passenger fields first.", false);
            // scroll to first invalid
            const firstBad = root.querySelector(".baBoxInput.is-invalid, .baPaxGender.is-invalid");
            if (firstBad && firstBad.scrollIntoView){
              try { firstBad.scrollIntoView({ behavior:"smooth", block:"center" }); } catch(_) {}
            }
            return;
          }

          // Update button to show "Processing..." with loading spinner
          const payBtn = document.getElementById("baPayBtn");
          const btnTitle = payBtn ? payBtn.querySelector(".baCTATitle") : null;
          if (btnTitle) {
            btnTitle.innerHTML = `
              Processing...
              <span style="display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite;margin-left:8px;vertical-align:middle"></span>
            `;
          }

          // Reveal payment UI sections (TCS, tips, Stripe area)
          // This will attempt to initialize Stripe Elements, but handles errors gracefully
          await revealPaymentUI();
          optionalServicesRevealed = true;
          
          console.log("[BOOK_FLOW] UI revealed successfully");
        }
      } catch (e) {
        // Fallback error handling
        console.error("[BOOK_FLOW] Unexpected error in handleBookClick:", e);
        if (hint) hint.textContent = "An unexpected error occurred. Please try again.";
        // Restore button text on error
        const payBtn = document.getElementById("baPayBtn");
        const btnTitle = payBtn ? payBtn.querySelector(".baCTATitle") : null;
        if (btnTitle) {
          btnTitle.textContent = "BOOK";
        }
      }
    }

    if (payBtn) {
      payBtn.addEventListener("click", () => {
        handleBookClick().catch((e) => {
          console.error("Error in Book button handler:", e);
        });
      });
    }

    // "Continue to Payment" button functionality has been merged into the Book button
    // The enterPaymentStep() function now handles payment initialization directly

    if (confirmBtn) {
      confirmBtn.addEventListener("click", async (e) => {
        // HARD VALIDATION: Prevent payment if button is disabled or validation fails
        if (confirmBtn.disabled || !validateBillingUI()) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
        
        try {
          // Double-check validation before proceeding
          if (!validateBillingUI()) {
            if (msg) msg.textContent = "Please complete all required fields and accept the terms.";
            return;
          }
          
          confirmBtn.disabled = true;
          confirmBtn.style.opacity = ".6";
          confirmBtn.style.cursor = "not-allowed";
          confirmBtn.style.pointerEvents = "none";
          if (msg) msg.textContent = "Processing payment…";

          const pi = await confirmStripePayment();

          const st = pi && pi.status ? pi.status : "unknown";
          if (st === "succeeded") {
            if (msg) msg.textContent = "Payment successful. Thank you!";
            setTimeout(async () => {
              try {
                const res = await fetch(GET_SESSION + "?public_id=" + encodeURIComponent(publicId), { method: "GET" });
                const fresh = await res.json();
                if (fresh && (fresh.paid_at || fresh.status === "paid")) renderSession(fresh);
              } catch (_) {}
            }, 1500);
          } else if (st === "processing") {
            if (msg) msg.textContent = "Payment processing. Please wait — confirmation will update shortly.";
          } else {
            if (msg) msg.textContent = "Payment status: " + st + ". If this looks wrong, contact your agent.";
          }

        } catch (e) {
          const errorMsg = e && e.message ? e.message : String(e);
          console.error("[BOOK_FLOW] Payment error:", errorMsg);
          if (msg) {
            msg.textContent = "Payment error: " + errorMsg;
            msg.style.color = "#b00020";
          }
          // Only re-enable if validation passes
          const isValid = validateBillingUI();
          confirmBtn.disabled = !isValid;
          confirmBtn.style.opacity = isValid ? "1" : ".6";
          confirmBtn.style.cursor = isValid ? "pointer" : "not-allowed";
          confirmBtn.style.pointerEvents = isValid ? "auto" : "none";
        }
      });
    }
  }

  // ---------- boot ----------
  if (!publicId) {
    renderError("Missing public_id in URL.");
    return;
  }

  renderLoading();

  fetch(GET_SESSION + "?public_id=" + encodeURIComponent(publicId), { method: "GET" })
    .then(async (res) => {
      const txt = await res.text();
      let data;
      try { data = JSON.parse(txt); } catch { throw new Error("Bad JSON response"); }
      if (!res.ok) throw new Error(data && data.error ? data.error : ("HTTP " + res.status));
      return data;
    })
    .then((data) => renderSession(data))
    .catch((err) => renderError(err && err.message ? err.message : String(err)));
})();
</script>
